<!--
    Deployment Framework for BizTalk
    Copyright (C) 2008-14 Thomas F. Abraham, 2004-08 Scott Colestock

    This source file is subject to the Microsoft Public License (Ms-PL).

    This is the core of the Deployment Framework for BizTalk.
    It should be included by the MSBuild file (.BTDFPROJ) for a particular BizTalk project that is
    leveraging the Framework.  It has the targets necessary for most BizTalk deployment tasks.

    The primary targets of interest will be:
    * Deploy               Used for deploying debug binaries on a development machine
    * Undeploy             Used for undeploying debug binaries on a development machine
    * UpdateOrchestration  Used during development when orchestration assemblies have changed but have NOT
                           affected port configuration.  Also updates component assemblies, SSO, maps and more.
    * ServerDeploy         Used for deploying binaries that are "co-located" with the build file, such
                           as after an MSI-based deployment.
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="Installer">
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="SetPropFromEnvSetting" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="GetPropsFromEnvSettingsDelimited" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="PrependToBindingPortNames" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="MakeFilesWriteable" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="ItemGroupFromSeparatedList" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="GeneratePdbCopyItemGroups" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="GenerateAssemblyNamesItemGroup" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="ConfigureVirtualDirectory" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="ConfigureVirtualDirectoryNtfsPermissions" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="ConfigureAppPool" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="ConfigureWebServiceExtension" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="RecycleAppPool" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="StripFileSpecFromPath" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="SetUpFileAdapterPaths" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="PopulateRulePoliciesMetadata" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="SetRegistryValue" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="Pause" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="ControlBizTalkHostInstance" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="PublishWcfServiceArtifacts" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="StartProcess" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="CheckXmlSyntax" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.dll" TaskName="WriteXmlValue" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.BizTalk.dll" TaskName="CheckForServiceInstances" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.BizTalk.dll" TaskName="AddAppReference" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.BizTalk.dll" TaskName="ControlBizTalkApp" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.BizTalk.dll" TaskName="GetBizTalkAppExists" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.BizTalk.dll" TaskName="UpdateSSOConfigItem" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.BizTalk.dll" TaskName="UpdateBizTalkAppDomainConfig" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.BizTalk.dll" TaskName="UpdateBizTalkDebuggingConfig" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.BizTalk.dll" TaskName="TerminateServiceInstances" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.BizTalk.dll" TaskName="ControlBizTalkOrchestrations" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.BizTalk.dll" TaskName="ControlBizTalkReceiveLocations" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.BizTalk.dll" TaskName="ControlBizTalkSendPorts" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.BizTalk.dll" TaskName="ControlBizTalkSendPortGroups" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.BizTalk.dll" TaskName="ControlBizTalkReferencedApps" />
  <UsingTask AssemblyFile="BizTalkDeploymentFramework.Tasks.BizTalk.dll" TaskName="ResumeServiceInstances" />

  <PropertyGroup>
    <!--
    From Microsoft.Common.targets
    OutDir:
    Indicates the final output location for the project or solution. When building a solution,
    OutDir can be used to gather multiple project outputs in one location. In addition,
    OutDir is included in AssemblySearchPaths used for resolving references.

    OutputPath:
    This property is usually specified in the project file and is used to initialize OutDir.
    OutDir and OutputPath are distinguished for legacy reasons, and OutDir should be used if at all possible.
    -->
    <OutDir Condition="'$(OutDir)' == ''">$(OutputPath)</OutDir>
    <!-- Example, bin\Debug\ -->
    <!-- Ensure OutDir has a trailing slash, so it can be concatenated -->
    <OutDir Condition="'$(OutDir)' != '' and !HasTrailingSlash('$(OutDir)')">$(OutDir)\</OutDir>
  </PropertyGroup>

  <PropertyGroup>
    <!-- Defaults for what deployment elements will be included.  Scripts that include this file should
        set these properties to false if they wish to exclude elements. -->
    <IncludeSchemas Condition="'$(IncludeSchemas)' == ''">true</IncludeSchemas>
    <IncludeOrchestrations Condition="'$(IncludeOrchestrations)' == ''">true</IncludeOrchestrations>
    <IncludeTransforms Condition="'$(IncludeTransforms)' == ''">true</IncludeTransforms>
    <IncludePipelines Condition="'$(IncludePipelines)' == ''">false</IncludePipelines>
    <IncludeComponents Condition="'$(IncludeComponents)' == ''">false</IncludeComponents>
    <IncludeInstallUtilForComponents Condition="'$(IncludeInstallUtilForComponents)' == ''">false</IncludeInstallUtilForComponents>
    <IncludePipelineComponents Condition="'$(IncludePipelineComponents)' == ''">false</IncludePipelineComponents>
    <IncludeCustomFunctoids Condition="'$(IncludeCustomFunctoids)' == ''">false</IncludeCustomFunctoids>
    <IncludeVocabAndRules Condition="'$(IncludeVocabAndRules)' == ''">false</IncludeVocabAndRules>
    <IncludeVirtualDirectories Condition="'$(IncludeVirtualDirectories)' == ''">false</IncludeVirtualDirectories>
    <IncludeMessagingBindings Condition="'$(IncludeMessagingBindings)' == ''">true</IncludeMessagingBindings>
    <IncludeDeploymentTest Condition="'$(IncludeDeploymentTest)' == ''">false</IncludeDeploymentTest>
    <Includelog4net Condition="'$(Includelog4net)' == ''">false</Includelog4net>
    <IncludeSSO Condition="'$(IncludeSSO)' == ''">false</IncludeSSO>

    <!-- Indicates whether or not to enable support for ESB Toolkit itineraries -->
    <IncludeEsbItineraries Condition="'$(IncludeEsbItineraries)' == ''">false</IncludeEsbItineraries>

    <!-- BAM definitions may be deployed by the script, but they will never be auto-undeployed because doing so
        will generally cause data loss.  BAM definitions may be undeployed using the target 'undeployBam'. -->
    <IncludeBAM Condition="'$(IncludeBAM)' == ''">false</IncludeBAM>

    <BAMViewSecurityRegEx Condition="'$(BAMViewSecurityRegEx)' == ''">(?'viewName'[\w\s]+)\s*:\s*(?'groupNames'.+)$</BAMViewSecurityRegEx>

    <!-- Configure BizTalk to run this application in an isolated AppDomain? -->
    <!-- This will update BTSNTSvc.exe.config to map this project's assemblies into a unique AppDomain. -->
    <UseIsolatedAppDomain Condition="'$(UseIsolatedAppDomain)' == ''">false</UseIsolatedAppDomain>

    <!-- These properties control debugging options built into BizTalk. -->
    <!-- Reference http://msdn.microsoft.com/en-us/library/aa578610(BTS.20).aspx -->
    <ConfigureBizTalkDebuggingFeatures Condition="'$(ConfigureBizTalkDebuggingFeatures)' == ''">false</ConfigureBizTalkDebuggingFeatures>
    <EnableBizTalkExtendedLogging Condition="'$(EnableBizTalkExtendedLogging)' == ''">false</EnableBizTalkExtendedLogging>
    <EnableBizTalkAssemblyValidation Condition="'$(EnableBizTalkAssemblyValidation)' == ''">false</EnableBizTalkAssemblyValidation>
    <EnableBizTalkCorrelationValidation Condition="'$(EnableBizTalkCorrelationValidation)' == ''">false</EnableBizTalkCorrelationValidation>
    <EnableBizTalkSchemaValidation Condition="'$(EnableBizTalkSchemaValidation)' == ''">false</EnableBizTalkSchemaValidation>

    <!-- Indicates whether to enable XML pre-processing, where settings from the SettingsFileGenerator.xml are 
        automatically merged into the binding XML file and/or other specified XML files. -->
    <EnableXmlPreprocess Condition="'$(EnableXmlPreprocess)' == ''">false</EnableXmlPreprocess>

    <!-- Indicates whether XMLPreprocess should look for ifdef preprocessor sections and replace macros (${id}) only
        within those sections (true), or whether it should simply replace all macros in the file (false) -->
    <RequireXmlPreprocessDirectives Condition="'$(RequireXmlPreprocessDirectives)' == ''">true</RequireXmlPreprocessDirectives>

    <!-- BizTalk Side-by-Side (SxS) Application Versioning -->
    <!--
		Sometimes one must deploy multiple versions of the same BizTalk application to the same BizTalk server.
		To make this easier, the script can auto-append a version number to the BizTalk application name and
		to the SSO affiliate app name.  In the future it may auto-append a version number to the port names too.
		
		There are three important version numbers:
		1) The assembly version numbers
		2) The "project version" number
		3) The "product version" number
		
		BizTalk will look at the assembly version numbers to decide if an assembly has changed, but it will only
		look at Major.Minor and ignore the rest.  These must be deliberately changed in order to deploy SxS to
		the GAC since the strong names include the version numbers.
		
		We also declare a script variable called "projectVersion".  This is the version number that is used
		in the install directory structure, BizTalk application name, SSO app name, etc.
		THIS VERSION SHOULD GENERALLY MATCH THE MAJOR.MINOR VERSION OF YOUR ASSEMBLIES.
		
		Finally, we declare a "ProductVersion" variable in the WiX setup script.  This version number represents
		the specific build version of the code.  For instance, you may be working on BTApp 1.1 (projectVersion),
		but you are creating an installer for the specific build BTApp 1.1.2358.2 (ProductVersion).  ProductVersion
		is used in the generated MSI filename and displays in Add/Remove Programs in the "support information" dialog.
		The ProductVersion is a good choice to receive your automated build's version number.
   -->
    <EnableSideBySide Condition="'$(EnableSideBySide)' == ''">false</EnableSideBySide>
    <ProjectVersion Condition="'$(ProjectVersion)' == ''">1.0</ProjectVersion>
    <DisableAutomaticPortNameVersioning Condition="'$(DisableAutomaticPortNameVersioning)' == ''">false</DisableAutomaticPortNameVersioning>

    <!-- Set this to false if you don't wish to deploy PDBs to the GAC.  Deploying PDBs
        to the GAC means more meaningful stack traces.  Consider turning on PDB creation
        for your release builds, too. Note that turning this on means a service-stop
        prior to deployment/undeployment, since loading PDBs causes the BTSNTSvc.exe process to
        hold on to assemblies even after orchestration unenlistment.  This means it might
        only be desirable on servers, to avoid delay for developers. -->
    <DeployPDBsToGac Condition="'$(DeployPDBsToGac)' == ''">false</DeployPDBsToGac>

    <!-- Set this to true to indicate you are using a "master" bindings file - such that xmlpreprocess
        doesn't overwrite it. -->
    <UsingMasterBindings Condition="'$(UsingMasterBindings)' == ''">false</UsingMasterBindings>

    <!-- Set this to true to indicate you are using ElementTunnel to maintain unescaped
        TransportTypeData.  See ElementTunnel.exe for more info. -->
    <ApplyXmlEscape Condition="'$(ApplyXmlEscape)' == ''">false</ApplyXmlEscape>

    <!-- The settings spreadsheet may contain sensitive information like passwords and connection strings. -->
    <!-- In many environments, it may be more appropriate to have your software support staff maintain and -->
    <!-- secure the spreadsheet rather than packaging it into the MSI. By default (true) the spreadsheet -->
    <!-- will be included in the MSI. -->
    <IncludeSettingsSpreadsheetInMsi Condition="'$(IncludeSettingsSpreadsheetInMsi)' == ''">true</IncludeSettingsSpreadsheetInMsi>

    <!-- You can set this to true if you are not using HTTP/SOAP, or you are but no custom
        pipelines are involved. -->
    <SkipIISReset Condition="'$(SkipIISReset)' == ''">false</SkipIISReset>

    <!-- Set to true to skip restarting the BizTalk host instances. -->
    <SkipHostInstancesRestart Condition="'$(SkipHostInstancesRestart)' == ''">false</SkipHostInstancesRestart>

    <!-- A single BizTalk bindings file name that contains definitions for ports and orchestrations. -->
    <PortBindings Condition="'$(PortBindings)' == ''">PortBindings.xml</PortBindings>

    <!-- Only used if useMasterBindings=true -->
    <PortBindingsMaster Condition="'$(PortBindingsMaster)' == ''">PortBindingsMaster.xml</PortBindingsMaster>

    <!-- Points to the location of the environment settings spreadsheet. -->
    <SettingsSpreadsheetPath Condition="'$(SettingsSpreadsheetPath)' == '' and Exists('$(MSBuildProjectDirectory)\SettingsFileGenerator.xml')">$(MSBuildProjectDirectory)\SettingsFileGenerator.xml</SettingsSpreadsheetPath>
    <SettingsSpreadsheetPath Condition="'$(SettingsSpreadsheetPath)' == ''">$(MSBuildProjectDirectory)\EnvironmentSettings\SettingsFileGenerator.xml</SettingsSpreadsheetPath>

    <!-- Path to the directory that will store settings files exported from the environment settings spreadsheet. -->
    <SettingsFilesExportPath Condition="'$(SettingsFilesExportPath)' == ''">$(MSBuildProjectDirectory)\EnvironmentSettings</SettingsFilesExportPath>

    <!-- These properties control the groups that will be used when creating an SSO affiliate app, if
        includeSSO property is true.  Override these in your .btdfproj file with the groups
        your targeted host account is a member of, or use SettingsFileGenerator.xml with PropsFromEnvSettings  -->
    <SsoAppUserGroup Condition="'$(SsoAppUserGroup)' == ''">BizTalk Application Users</SsoAppUserGroup>
    <SsoAppAdminGroup Condition="'$(SsoAppAdminGroup)' == ''">BizTalk Server Administrators</SsoAppAdminGroup>

    <IISAppPoolDefaultDeployAction Condition="'$(IISAppPoolDefaultDeployAction)' == ''">CreateOrUpdate</IISAppPoolDefaultDeployAction>
    <IISAppPoolDefaultUndeployAction Condition="'$(IISAppPoolDefaultUndeployAction)' == ''">Delete</IISAppPoolDefaultUndeployAction>
    
    <!-- Specifies whether to edit the NTFS permissions of an IIS virtual directory path to grant rights to the
        aspnet/AppPool identity account. -->
    <ModifyNTFSPermissionsOnVDirPaths Condition="'$(ModifyNTFSPermissionsOnVDirPaths)' == ''">true</ModifyNTFSPermissionsOnVDirPaths>

    <!-- Customize if needed (in seconds) -->
    <IisResetTime Condition="'$(IisResetTime)' == ''">60</IisResetTime>

    <!-- Indicates whether a BTS application start should be performed after deployment. -->
    <StartApplicationOnDeploy Condition="'$(StartApplicationOnDeploy)' == ''">true</StartApplicationOnDeploy>

    <!-- Indicates whether a BTS application stop should be performed during undeployment. -->
    <StopApplicationOnDeploy Condition="'$(StopApplicationOnDeploy)' == ''">true</StopApplicationOnDeploy>
    
    <!-- Indicates whether to resume all suspended instances associated with the application during deployment. -->
    <ResumeSuspendedInstancesOnDeploy Condition="'$(ResumeSuspendedInstancesOnDeploy)' == ''">true</ResumeSuspendedInstancesOnDeploy>

    <!-- Indicates whether a BTS application start after deployment should enable receive locations. -->
    <EnableAllReceiveLocationsOnDeploy Condition="'$(EnableAllReceiveLocationsOnDeploy)' == ''">true</EnableAllReceiveLocationsOnDeploy>

    <!-- Indicates whether a BTS application start after deployment should start all referenced applications. -->
    <StartReferencedApplicationsOnDeploy Condition="'$(StartReferencedApplicationsOnDeploy)' == ''">true</StartReferencedApplicationsOnDeploy>

    <!-- Indicates whether to use BizTalk's Start/Stop Application process (same as BizTalk Admin) instead of the Deployment Framework's
         own granular application control. -->
    <UseLegacyApplicationControl Condition="'$(UseLegacyApplicationControl)' == ''">false</UseLegacyApplicationControl>

    <!-- Location of deployment-related scripts and tools, and target directory for deployment results. -->
    <!-- Note corresponding directories in MSI project. -->
    <DeployResults Condition="'$(DeployResults)' == ''">..\DeployResults</DeployResults>

    <!-- Flag typically used on MSBuild command line to indicate that undeploy targets should be skipped.
        This speeds up a first-time server-style deployment.  Referenced by the "unless" attribute on many targets below. -->
    <SkipUndeploy Condition="'$(SkipUndeploy)' == ''">false</SkipUndeploy>

    <!-- Flag typically used on MSBuild command line to indicate whether we are deploying to BizTalk management database. -->
    <DeployBizTalkMgmtDB Condition="'$(DeployBizTalkMgmtDB)' == ''">true</DeployBizTalkMgmtDB>

    <!-- Indicates whether to un-GAC external assemblies during undeployment or to leave them alone. -->
    <UndeployExternalAssemblies Condition="'$(UndeployExternalAssemblies)' == ''">true</UndeployExternalAssemblies>

    <!-- The registry key where log4net configuration file location information 
        will be written to/read from if we are using log4net -->
    <Log4netRegKey Condition="'$(Log4netRegKey)' == ''">HKEY_LOCAL_MACHINE\SOFTWARE\$(ProjectName)\log4netConfig</Log4netRegKey>

    <!-- Indicates whether all physical file paths in the binding file that are associated with FILE adapters should be
        automatically created and/or assigned file system permissions. -->
    <ManageFileAdapterPhysicalPaths Condition="'$(ManageFileAdapterPhysicalPaths)' == ''">true</ManageFileAdapterPhysicalPaths>

    <!-- Indicates whether all physical file paths in the binding file that are associated with FILE adapters should be
        deleted when the application is undeployed.  Acceptable values: Never, DeleteIfEmpty, DeleteRecursive -->
    <DeleteFileAdapterPhysicalPathsOnUndeploy Condition="'$(DeleteFileAdapterPhysicalPathsOnUndeploy)' == ''">Never</DeleteFileAdapterPhysicalPathsOnUndeploy>

    <!-- Indicates whether rule policies should be removed from the BizTalk application (visible in Policies node
        in BizTalk Admin) when the application is undeployed. Regardless of this setting value, the policies will
        always be removed from the rule store. If the application is going to be deleted then there is no need to
        remove the rules from it. This option may be useful if you are undeploying rules separate from an
        application undeployment. -->
    <RemoveRulePoliciesFromAppOnUndeploy Condition="'$(RemoveRulePoliciesFromAppOnUndeploy)' == ''">false</RemoveRulePoliciesFromAppOnUndeploy>

    <!-- Indicates whether rule policies should be explicitly deployed during deployment. Regardless of this setting
        value, the policies will always be _published_, but are normally _deployed_ automatically by BizTalk when the
        BizTalk application starts. Part of the deployment process associates the rule policies with the BizTalk
        application. If you need the policies to be deployed without having to start the BizTalk application, then
        set this option to true. -->
    <ExplicitlyDeployRulePoliciesOnDeploy Condition="'$(ExplicitlyDeployRulePoliciesOnDeploy)' == ''">true</ExplicitlyDeployRulePoliciesOnDeploy>

    <!-- Allows a specific description to be set on the BizTalk application for display in BizTalk Admin. -->
    <BizTalkAppDescription Condition="'$(BizTalkAppDescription)' == ''">$(ProjectName)</BizTalkAppDescription>

    <!-- Default regular expression used to assign assemblies into custom .NET AppDomains if no value is supplied for BizTalkAppDomain AssemblyNameRegexes and AssemblyNames -->
    <BizTalkAppDomainAssemblyNameRegexesDefault Condition="'$(BizTalkAppDomainAssemblyNameRegexesDefault)' == ''">($(ProjectName),.*)|($(ProjectName)\..*)</BizTalkAppDomainAssemblyNameRegexesDefault>
  </PropertyGroup>

  <PropertyGroup Condition="'$(Configuration)' != 'Server'">
    <!-- Indicates that BAM profile definitions should not be undeployed.  Undeploying a profile may cause existing BAM
        data to be lost. -->
    <SkipBamUndeploy Condition="'$(SkipBamUndeploy)' == ''">false</SkipBamUndeploy>

    <!-- Indicates whether to automatically terminate any message instances associated with the application during deployment -->
    <AutoTerminateInstances Condition="'$(AutoTerminateInstances)' == ''">true</AutoTerminateInstances>

    <!-- Points to the local (developer) environment settings file exported from the environment settings spreadsheet. -->
    <!-- The environment setings spreadsheet has default columns for local, dev, test and prod. -->
    <!-- If <DeveloperPreProcessSettings> is not defined, the dev settings will be used. -->
    <DeveloperPreProcessSettings Condition="'$(DeveloperPreProcessSettings)' == ''">$(MSBuildProjectDirectory)\EnvironmentSettings\Exported_LocalSettings.xml</DeveloperPreProcessSettings>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)' == 'Server'">
    <!-- Indicates that BAM profile definitions should not be undeployed.  Undeploying a profile may cause existing BAM
        data to be lost.  Referenced by the "unless" attribute on the undeployBam target below. -->
    <SkipBamUndeploy Condition="'$(SkipBamUndeploy)' == ''">true</SkipBamUndeploy>
  </PropertyGroup>

  <ItemGroup>
    <!--
    From Microsoft.Common.targets
    Create the output path as an item so that we can use %(FullPath) on it.
    -->
    <_OutputPathItem Include="$(OutDir)"/>
  </ItemGroup>

  <PropertyGroup>
    <!-- Example, c:\MyProjects\MyProject\bin\debug\ -->
    <!--
    From Microsoft.Common.targets
    Condition intentionally omitted on this one, because it causes problems
    when we pick up the value of an environment variable named TargetDir 
    -->
    <TargetDir>@(_OutputPathItem->'%(FullPath)')</TargetDir>
  </PropertyGroup>

  <ItemGroup>
    <PortBindingsFile Include="$(PortBindings)" />
  </ItemGroup>

  <!-- This ItemGroup is deprecated in favor of BizTalkAppDomain -->
  <ItemGroup>
    <AllPatternAssignmentRule Include="*">
      <AssemblyNamePattern>$(ProjectName).*</AssemblyNamePattern>
    </AllPatternAssignmentRule>
  </ItemGroup>

  <!-- One or more schema assemblies (least dependent first, if schema assemblies reference each other.) -->
  <ItemGroup Condition="'@(Schemas)' == '' and '$(IncludeSchemas)' == 'true'">
    <Schemas Include="$(ProjectName).Schemas.dll">
      <LocationPath>..\$(ProjectName).Schemas\bin\$(Configuration)</LocationPath>
    </Schemas>
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' != 'Server'">
    <SchemasQualified Include="@(Schemas->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' == 'Server'">
    <SchemasQualified Include="@(Schemas->'..\%(Identity)')" />
  </ItemGroup>

  <!-- One or more pipeline assemblies -->
  <ItemGroup Condition="'@(Pipelines)' == '' and '$(IncludePipelines)' == 'true'">
    <Pipelines Include="$(ProjectName).Pipelines.dll">
      <LocationPath>..\$(ProjectName).Pipelines\bin\$(Configuration)</LocationPath>
    </Pipelines>
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' != 'Server'">
    <PipelinesQualified Include="@(Pipelines->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' == 'Server'">
    <PipelinesQualified Include="@(Pipelines->'..\%(Identity)')" />
  </ItemGroup>

  <!-- One or more transform assemblies -->
  <ItemGroup Condition="'@(Transforms)' == '' and '$(IncludeTransforms)' == 'true'">
    <Transforms Include="$(ProjectName).Transforms.dll">
      <LocationPath>..\$(ProjectName).Transforms\bin\$(Configuration)</LocationPath>
    </Transforms>
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' != 'Server'">
    <TransformsQualified Include="@(Transforms->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' == 'Server'">
    <TransformsQualified Include="@(Transforms->'..\%(Identity)')" />
  </ItemGroup>

  <!-- One or more orchestration assemblies -->
  <ItemGroup Condition="'@(Orchestrations)' == '' and '$(IncludeOrchestrations)' == 'true'">
    <Orchestrations Include="$(ProjectName).Orchestrations.dll">
      <LocationPath>..\$(ProjectName).Orchestrations\bin\$(Configuration)</LocationPath>
    </Orchestrations>
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' != 'Server'">
    <OrchestrationsQualified Include="@(Orchestrations->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' == 'Server'">
    <OrchestrationsQualified Include="@(Orchestrations->'..\%(Identity)')" />
  </ItemGroup>

  <!-- One or more functoid assemblies -->
  <ItemGroup Condition="'@(CustomFunctoids)' == '' and '$(IncludeCustomFunctoids)' == 'true'">
    <CustomFunctoids Include="$(ProjectName).CustomFunctoids.dll">
      <LocationPath>..\$(ProjectName).CustomFunctoids\bin\$(Configuration)</LocationPath>
    </CustomFunctoids>
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' != 'Server'">
    <CustomFunctoidsQualified Include="@(CustomFunctoids->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' == 'Server'">
    <CustomFunctoidsQualified Include="@(CustomFunctoids->'..\%(Identity)')" />
  </ItemGroup>

  <!-- One or more .NET component assemblies -->
  <ItemGroup Condition="'@(Components)' == '' and '$(IncludeComponents)' == 'true'">
    <Components Include="$(ProjectName).Components.dll">
      <LocationPath>..\$(ProjectName).Components\bin\$(Configuration)</LocationPath>
    </Components>
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' != 'Server'">
    <ComponentsQualified Include="@(Components->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' == 'Server'">
    <ComponentsQualified Include="@(Components->'..\%(Identity)')" />
  </ItemGroup>

  <!-- One or more pipeline component assemblies -->
  <ItemGroup Condition="'@(PipelineComponents)' == '' and '$(IncludePipelineComponents)' == 'true'">
    <PipelineComponents Include="$(ProjectName).PipelineComponents.dll">
      <LocationPath>..\$(ProjectName).PipelineComponents\bin\$(Configuration)</LocationPath>
    </PipelineComponents>
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' != 'Server'">
    <PipelineComponentsQualified Include="@(PipelineComponents->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' == 'Server'">
    <PipelineComponentsQualified Include="@(PipelineComponents->'..\%(Identity)')" />
  </ItemGroup>

  <!-- One or more BAM definition workbooks -->
  <ItemGroup Condition="'@(BamDefinitions)' == '' and '$(IncludeBAM)' == 'true'">
    <BamDefinitions Include="$(ProjectName).BAM.xls">
      <LocationPath>..\$(ProjectName).BAM</LocationPath>
    </BamDefinitions>
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' != 'Server'">
    <BamDefinitionsQualified Include="@(BamDefinitions->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' == 'Server'">
    <BamDefinitionsQualified Include="@(BamDefinitions->'..\BAM\%(Identity)')" />
  </ItemGroup>

  <!-- One or more BAM tracking profiles -->
  <!--
  DO NOT UNCOMMENT. This is just to demonstrate the usage of the ItemGroup. Should only be included in a .btdfproj.
  <ItemGroup>
    <BamTrackingProfiles Include="SomeFile.btt">
      <LocationPath>..\$(ProjectName).BAM</LocationPath>
    </BamTrackingProfiles>
  </ItemGroup>
  -->
  <ItemGroup Condition="'$(Configuration)' != 'Server' and '@(BamTrackingProfiles)' != ''">
    <BamTrackingProfilesQualified Include="@(BamTrackingProfiles->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' == 'Server' and '@(BamTrackingProfiles)' != ''">
    <BamTrackingProfilesQualified Include="@(BamTrackingProfiles->'..\BAM\%(Identity)')" />
  </ItemGroup>

  <!-- The list of additional assemblies that will be deployed to the GAC from the DeployTools folder. -->
  <ItemGroup Condition="'@(AdditionalAssemblies)' == '' and '$(Includelog4net)' == 'true'">
    <AdditionalAssemblies Include="log4net.dll" />
    <AdditionalAssemblies Include="log4net.Ext.Serializable.dll" />
    <AdditionalAssemblies Include="SSOSettingsFileReader.dll" />
  </ItemGroup>
  <ItemGroup Condition="'@(AdditionalAssemblies)' == '' and '$(Includelog4net)' == 'false'">
    <AdditionalAssemblies Include="SSOSettingsFileReader.dll" />
  </ItemGroup>

  <!-- A single NUnit assembly that can be used for unit testing. -->
  <ItemGroup Condition="'@(DeploymentTest)' == '' and '$(IncludeDeploymentTest)' == 'true'">
    <DeploymentTest Include="$(ProjectName).DeploymentTest.dll">
      <LocationPath>..\$(ProjectName).DeploymentTest\bin\$(Configuration)</LocationPath>
    </DeploymentTest>
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' != 'Server'">
    <DeploymentTestQualified Include="@(DeploymentTest->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>

  <!-- A list of files to preprocess with XmlPreprocess -->
  <!--
  DO NOT UNCOMMENT. This is just to demonstrate the usage of the ItemGroup. Should only be included in a .btdfproj.
  <ItemGroup>
    <FilesToXmlPreprocess Include="SomeFile.xml">
      <LocationPath>..</LocationPath>
      <OutputFilename>SomeFileProcessed.xml</OutputFilename>
    </FilesToXmlPreprocess>
  </ItemGroup>
  -->
  <ItemGroup Condition="'$(Configuration)' != 'Server' and '@(FilesToXmlPreprocess)' != ''">
    <FilesToXmlPreprocessQualified Include="@(FilesToXmlPreprocess->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' == 'Server' and '@(FilesToXmlPreprocess)' != ''">
    <FilesToXmlPreprocessQualified Include="@(FilesToXmlPreprocess->'..\%(Identity)')" />
  </ItemGroup>

  <!-- A list of assembly filenames to be included with the solution and GAC'd during deployment. -->
  <!--
  DO NOT UNCOMMENT. This is just to demonstrate the usage of the ItemGroup. Should only be included in a .btdfproj.
  <ItemGroup>
    <ExternalAssemblies Include="Dummy.dll">
      <LocationPath>..\ExternalReferences</LocationPath>
    </ExternalAssemblies>
  </ItemGroup>
  -->
  <ItemGroup Condition="'$(Configuration)' != 'Server' and '@(ExternalAssemblies)' != ''">
    <ExternalAssembliesQualified Include="@(ExternalAssemblies->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' == 'Server' and '@(ExternalAssemblies)' != ''">
    <ExternalAssembliesQualified Include="@(ExternalAssemblies->'..\ExternalAssemblies\%(Identity)')" />
  </ItemGroup>

  <!-- A list of additional files to be included in the MSI and installed alongside the other solution files. -->
  <!--
  DO NOT UNCOMMENT. This is just to demonstrate the usage of the ItemGroup. Should only be included in a .btdfproj.
  <ItemGroup>
    <AdditionalFiles Include="NecessaryFile.xml">
      <LocationPath>..\NecessaryFiles</LocationPath>
    </AdditionalFiles>
  </ItemGroup>
  -->
  <ItemGroup Condition="'$(Configuration)' != 'Server' and '@(AdditionalFiles)' != ''">
    <AdditionalFilesQualified Include="@(AdditionalFiles->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>

  <!-- A list of BRE vocabulary files to be included with the solution and published during deployment. -->
  <ItemGroup Condition="'@(RuleVocabularies)' == '' and '$(IncludeVocabAndRules)' == 'true'">
    <RuleVocabularies Include="$(ProjectName).Vocabularies.xml">
      <LocationPath>..\$(ProjectName).BRE</LocationPath>
    </RuleVocabularies>
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' != 'Server' and '@(RuleVocabularies)' != ''">
    <RuleVocabulariesQualified Include="@(RuleVocabularies->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' == 'Server' and '@(RuleVocabularies)' != ''">
    <RuleVocabulariesQualified Include="@(RuleVocabularies->'..\BRE\Vocabularies\%(Identity)')" />
  </ItemGroup>

  <!-- A list of BRE policy files to be included with the solution and published during deployment. -->
  <ItemGroup Condition="'@(RulePolicies)' == '' and '$(IncludeVocabAndRules)' == 'true'">
    <RulePolicies Include="$(ProjectName).Policies.xml">
      <LocationPath>..\$(ProjectName).BRE</LocationPath>
    </RulePolicies>
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' != 'Server' and '@(RulePolicies)' != ''">
    <RulePoliciesQualified Include="@(RulePolicies->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' == 'Server' and '@(RulePolicies)' != ''">
    <RulePoliciesQualified Include="@(RulePolicies->'..\BRE\Policies\%(Identity)')" />
  </ItemGroup>

  <!-- A list of ESB Toolkit itinerary files to be included with the solution and published during deployment. -->
  <ItemGroup Condition="'@(EsbItineraries)' == '' and '$(IncludeEsbItineraries)' == 'true'">
    <EsbItineraries Include="$(ProjectName).itinerary">
      <LocationPath>..\$(ProjectName).ESB</LocationPath>
    </EsbItineraries>
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' != 'Server' and '@(EsbItineraries)' != ''">
    <EsbItinerariesQualified Include="@(EsbItineraries->'%(LocationPath)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup Condition="'$(Configuration)' == 'Server' and '@(EsbItineraries)' != ''">
    <EsbItinerariesQualified Include="@(EsbItineraries->'..\ESB\%(Identity)')" />
  </ItemGroup>

  <!-- If you wish to set up IIS application pools, specify one or more IISAppPool definitions. -->
  <!--
  DO NOT UNCOMMENT. This is just to demonstrate the usage of the ItemGroup. Should only be included in a .btdfproj.
  AppPoolNetVersion may be v1.0, v1.1, v2.0 or v4.0
  <ItemGroup>
    <IISAppPool Include="TestProjectPool">
      <DotNetFrameworkVersion>v4.0</DotNetFrameworkVersion>
      <PipelineMode>Integrated</PipelineMode>
      <Enable32Bit>False</Enable32Bit>
      <IdentityType>SpecificUser</IdentityType>
      <UserName>BizTalk</UserName>
      <Password>password</Password>
      <DeployAction>Create</DeployAction>
      <UndeployAction>Delete</UndeployAction>
    </IISAppPool>
  </ItemGroup>
  -->

  <!-- If you wish to set up IIS applications, specify one or more IISApp definitions. -->
  <!--
  DO NOT UNCOMMENT. This is just to demonstrate the usage of the ItemGroup. Should only be included in a .btdfproj.
  <ItemGroup>
    <IISApp Include="TestProject">
      <AppPoolName>TestProjectPool</AppPoolName>
      <SiteName>Default Web Site</SiteName>
      <VirtualPath>/TestProject</VirtualPath>
      <PhysicalPath>..\TestProjectVDir</PhysicalPath>
      <DeployAction>Create</DeployAction>
      <UndeployAction>Delete</UndeployAction>
    </IISApp>
  </ItemGroup>
  -->

  <!-- If you wish to limit which BizTalk hosts are restarted, specify one or more host names. -->
  <!--
  DO NOT UNCOMMENT. This is just to demonstrate the usage of the ItemGroup. Should only be included in a .btdfproj.
  <ItemGroup>
    <BizTalkHosts Include="BizTalkServerApplication" />
  </ItemGroup>
  -->

  <!-- If you wish to add references to other BizTalk applications, specify one or more application names. -->
  <!--
  DO NOT UNCOMMENT. This is just to demonstrate the usage of the ItemGroup. Should only be included in a .btdfproj.
  <ItemGroup>
    <AppsToReference Include="AnotherBizTalkApplication" />
  </ItemGroup>
  -->

  <!-- A list of named MSBuild properties to be created based on values pulled from the settings spreadsheet.
      The name of the property specified here must exactly match the name specified in a row in the settings spreadsheet. -->
  <!--
  DO NOT UNCOMMENT. This is just to demonstrate the usage of the ItemGroup. Should only be included in a .btdfproj.
  <ItemGroup>
    <PropsFromEnvSettings Include="ssoAppUserGroup;ssoAppAdminGroup;BAMViewsAndAccounts" />
  </ItemGroup>
  -->

  <!-- A list of .NET AppDomains to configure for the application -->
  <!--
  DO NOT UNCOMMENT. This is just to demonstrate the usage of the ItemGroup. Should only be included in a .btdfproj.
  <BizTalkAppDomain Include="MyApp">
    <ApplicationBase>$(MSBuildProjectDirectory)\</ConfigurationFilePath>
    <AssemblyNameRegexes>(MyApp,.*)|(MyApp\..*);MyAppComponent.*</AssemblyNameRegexes>
    <AssemblyNames>MyApp.Maps, Version=1.0.0.0, Culture=neutral, PublicKeyToken=51a4d4439455a1a7</AssemblyNames>
    <ConfigurationFilePath>$(MSBuildProjectDirectory)\MyApp.config</ConfigurationFilePath>
    <PrivateBinPath>bin</PrivateBinPath>
    <SecondsEmptyBeforeShutdown>90</SecondsEmptyBeforeShutdown>
    <SecondsIdleBeforeShutdown>60</SecondsIdleBeforeShutdown>
  </BizTalkAppDomain>
  -->

  <PropertyGroup>
    <!-- Used for copying pipeline components to the correct directory, among other things. This key is unchanged between BizTalk releases. -->
    <BtsDir Condition="'$(BtsDir)' == ''">$([MSBuild]::GetRegistryValueFromView('HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\BizTalk Server\3.0', 'InstallPath', null, RegistryView.Registry64, RegistryView.Registry32))</BtsDir>

    <BizTalkProductName Condition="'$(BizTalkProductName)' == ''">$([MSBuild]::GetRegistryValueFromView('HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\BizTalk Server\3.0', 'ProductName', null, RegistryView.Registry64, RegistryView.Registry32))</BizTalkProductName>
    
    <BizTalkVersion Condition="'$(BizTalkProductName)' == 'Microsoft BizTalk Server 2010'">BTS2010</BizTalkVersion>
    <BizTalkVersion Condition="'$(BizTalkProductName)' == 'Microsoft BizTalk Server 2013'">BTS2013</BizTalkVersion>
    <BizTalkVersion Condition="'$(BizTalkProductName)' == 'Microsoft BizTalk Server 2013 R2'">BTS2013R2</BizTalkVersion>
    <BizTalkVersion Condition="'$(BizTalkProductName)' == 'Microsoft BizTalk Server 2016'">BTS2016</BizTalkVersion>

    <DotNetFrameworkVersion Condition="'$(DotNetFrameworkVersion)' == '' and '$(BizTalkVersion)' == 'BTS2010'">Version40</DotNetFrameworkVersion>
    <DotNetFrameworkVersion Condition="'$(DotNetFrameworkVersion)' == '' and '$(BizTalkVersion)' == 'BTS2013'">Version45</DotNetFrameworkVersion>
    <DotNetFrameworkVersion Condition="'$(DotNetFrameworkVersion)' == '' and '$(BizTalkVersion)' == 'BTS2013R2'">Version45</DotNetFrameworkVersion>
    <DotNetFrameworkVersion Condition="'$(DotNetFrameworkVersion)' == '' and '$(BizTalkVersion)' == 'BTS2016'">Version45</DotNetFrameworkVersion>

    <FrameworkDir Condition="'$(FrameworkDir)' == ''">$([Microsoft.Build.Utilities.ToolLocationHelper]::GetPathToDotNetFramework(Microsoft.Build.Utilities.TargetDotNetFrameworkVersion.$(DotNetFrameworkVersion)))</FrameworkDir>

    <!-- Set up DeploymentFrameworkRootDir -->
    <!--   We need to convert a user-specified value of DeploymentFrameworkRootDir to a fully-qualified path. -->
    <!--   Ensure that the path has a trailing backslash before calling GetParent(). GetParent() will simply remove the trailing backslash -->
    <!--   and return a DirectoryInfo object that gives us what we really want - the FullName property with a fully-qualified path. -->
    <!--   GetParent() uses the current working directory to convert relative paths, so we always send it a fully qualified path using -->
    <!--   MSBuildProjectDirectory to force the path to be relative to our project directory.  It will convert C:\proj\myproj\..\BTDF -->
    <!--   into C:\proj\BTDF, which is the clean path that we want. -->
    <!-- The final value of DeploymentFrameworkRootDir must end in a backslash. -->
    <DeploymentFrameworkRootDir
      Condition="'$(DeploymentFrameworkRootDir)' != '' and !HasTrailingSlash('$(DeploymentFrameworkRootDir)')">$(DeploymentFrameworkRootDir)\</DeploymentFrameworkRootDir>
    <DeploymentFrameworkRootDirIsFullyQualified>$([System.IO.Path]::IsPathRooted($(DeploymentFrameworkRootDir)))</DeploymentFrameworkRootDirIsFullyQualified>
    <DeploymentFrameworkRootDir
      Condition="'$(DeploymentFrameworkRootDir)' != '' and '$(DeploymentFrameworkRootDirIsFullyQualified)' == 'False'">$([System.IO.Directory]::GetParent($(MSBuildProjectDirectory)\$(DeploymentFrameworkRootDir)).FullName)\</DeploymentFrameworkRootDir>

    <DeploymentFrameworkRootDir Condition="'$(DeploymentFrameworkRootDir)' == '' and '$(Configuration)' != 'Server'">$([MSBuild]::GetRegistryValueFromView('HKEY_LOCAL_MACHINE\SOFTWARE\DeploymentFrameworkForBizTalk', 'InstallPath', null, RegistryView.Registry64, RegistryView.Registry32))</DeploymentFrameworkRootDir>
    <DeploymentFrameworkRootDir Condition="'$(DeploymentFrameworkRootDir)' == '' and '$(Configuration)' == 'Server'">$(MSBuildProjectDirectory)\</DeploymentFrameworkRootDir>

    <DeploymentFrameworkDir>$(DeploymentFrameworkRootDir)Framework</DeploymentFrameworkDir>
    <DeploymentFrameworkDeveloperDir>$(DeploymentFrameworkRootDir)Developer</DeploymentFrameworkDeveloperDir>
    <DeployTools Condition="'$(DeployTools)' == ''">$(DeploymentFrameworkDir)\DeployTools</DeployTools>
    <Gacutil Condition="'$(Gacutil)' == ''">$(DeployTools)\gacutil.exe</Gacutil>
    <XmlEscapeXPathsFile Condition="'$(XmlEscapeXPathsFile)' == ''">$(DeployTools)\adapterXPaths.txt</XmlEscapeXPathsFile>

    <AppCmd Condition="'$(AppCmd)' == ''">$(SystemRoot)\System32\inetsrv\appcmd.exe</AppCmd>

    <!-- Look for the BizTalk ESB Toolkit 2.1 install path -->
    <EsbDir Condition="'$(EsbDir)' == ''">$([MSBuild]::GetRegistryValueFromView('HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\BizTalk ESB Toolkit\2.1', 'InstallPath', null, RegistryView.Registry64, RegistryView.Registry32))</EsbDir>
    <!-- Look for the BizTalk ESB Toolkit 2.2 install path -->
    <EsbDir Condition="'$(EsbDir)' == ''">$([MSBuild]::GetRegistryValueFromView('HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\BizTalk ESB Toolkit', 'InstallPath', null, RegistryView.Registry64, RegistryView.Registry32))</EsbDir>

    <EsbImportUtil Condition="'$(EsbDir)' != '' and '$(EsbImportUtil)' == ''">$(EsbDir)bin\EsbImportUtil.exe</EsbImportUtil>
    
    <IisMajorVersion Condition="'$(IisMajorVersion)' == ''">$([MSBuild]::GetRegistryValueFromView('HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\InetStp', 'MajorVersion', null, RegistryView.Registry64, RegistryView.Registry32))</IisMajorVersion>
    
    <Is64bitOS Condition="'$(MSBuildExtensionsPath64)' == ''">false</Is64bitOS>
    <Is64bitOS Condition="'$(MSBuildExtensionsPath64)' != ''">true</Is64bitOS>
    
    <MSBuildProjectDirectoryParent Condition="'$(MSBuildProjectDirectoryParent)' == ''">$([System.IO.Directory]::GetParent($(MSBuildProjectDirectory)).FullName)</MSBuildProjectDirectoryParent>
    
    <Btshttpreceive Condition="'$(Btshttpreceive)' == ''">btshttpreceive.dll</Btshttpreceive>

    <SourceBindingFile Condition="'$(UsingMasterBindings)' == 'false'">$(PortBindings)</SourceBindingFile>
    <SourceBindingFile Condition="'$(UsingMasterBindings)' == 'true'">$(PortBindingsMaster)</SourceBindingFile>
  </PropertyGroup>

  <PropertyGroup Condition="'$(BizTalkAppName)' == ''">
    <BizTalkAppName Condition="'$(EnableSideBySide)' == 'true'">$(ProjectName)_$(ProjectVersion)</BizTalkAppName>
    <BizTalkAppName Condition="'$(EnableSideBySide)' != 'true'">$(ProjectName)</BizTalkAppName>
  </PropertyGroup>
  
  <ItemGroup>
    <Log4netFile Include="$(MSBuildProjectDirectoryParent)\$(ProjectName).log4net" />
  </ItemGroup>

  <Target Name="PrintHeader">
    <Message Text="Using Deployment Framework Install Path '$(DeploymentFrameworkRootDir)'." />
    <Message Text="Using Deployment Framework Tools Path '$(DeployTools)'." />
    <Message Text="Using .NET Framework Install Path '$(FrameworkDir)'." />
    <Message Text="Using BizTalk Install Path '$(BtsDir)'." />
    <Message Text="Using BizTalk ESB Toolkit Install Path '$(EsbDir)'." Condition="'$(EsbDir)' != ''" />
    <Message Text="Detected IIS $(IisMajorVersion)" Condition="'$(IisMajorVersion)' != ''" />
    <Message Text="Using BizTalk Application Name '$(BizTalkAppName)'" />
  </Target>

  <Target Name="LoadPropsFromEnvSettingsThenExecute" DependsOnTargets="SetPropertiesFromEnvironmentSettings">
    <Error
      Text="Must set the property TargetsAfterLoadPropsFromEnvSettings with a semicolon-delimited list of targets to execute after loading properties from the spreadsheet."
      Condition="'$(TargetsAfterLoadPropsFromEnvSettings)' == ''" />
    
    <MSBuild
      Projects="$(MSBuildProjectFullPath)"
      Properties="LoadedPropsFromEnvSettings=True;SkipExportSettings=True;$(PropsFromEnvSettingsDelimited)"
      Targets="$(TargetsAfterLoadPropsFromEnvSettings)"
      UseResultsCache="false" UnloadProjectsOnCompletion="true" />
  </Target>

  <PropertyGroup>
    <FrameworkInitializeDependsOn>
      PrintHeader;
      ExportSettings;
      CustomPostExportSettings;
      SetPropertiesFromEnvironmentSettings
    </FrameworkInitializeDependsOn>
  </PropertyGroup>

  <Target Name="FrameworkInitialize" DependsOnTargets="$(FrameworkInitializeDependsOn)" />

  <Target Name="InitSettingsFilePath" DependsOnTargets="ExportSettings" Condition="'$(SettingsFilePath)' == ''">
    <!-- Use either the settings file that comes from SetEnvUI, or devl/local settings if doing workstation deployment. -->
    <PropertyGroup>
      <SettingsFilePath Condition="'$(Configuration)' == 'Server' and '$(ENV_SETTINGS)' != ''">$(ENV_SETTINGS)</SettingsFilePath>
      <SettingsFilePath Condition="'$(Configuration)' != 'Server' and '$(DeveloperPreProcessSettings)' != '' and Exists('$(DeveloperPreProcessSettings)')">$(DeveloperPreProcessSettings)</SettingsFilePath>
      <SettingsFilePath Condition="'$(Configuration)' != 'Server' and '$(DeveloperPreProcessSettings)' != '' and !Exists('$(DeveloperPreProcessSettings)') and Exists('$(SettingsFilesExportPath)\local_settings.xml')">$(SettingsFilesExportPath)\local_settings.xml</SettingsFilePath>
      <SettingsFilePath Condition="'$(Configuration)' != 'Server' and '$(DeveloperPreProcessSettings)' == ''">$(SettingsFilesExportPath)\Exported_DevSettings.xml</SettingsFilePath>
      <SettingsFilePath Condition="'$(Configuration)' == 'Server' and '$(DeploymentMode)' != 'Deploy' and '$(SettingsFilePath)' == ''">$([MSBuild]::GetRegistryValueFromView('HKEY_LOCAL_MACHINE\SOFTWARE\$(Manufacturer)\$(ProductName)', 'LastDeploySettingsFilePath', null, RegistryView.Registry64, RegistryView.Registry32))</SettingsFilePath>
    </PropertyGroup>

    <SetRegistryValue KeyName="HKEY_LOCAL_MACHINE\SOFTWARE\$(Manufacturer)\$(ProductName)" ValueName="LastDeploySettingsFilePath" Value="$(SettingsFilePath)"
      Condition="'$(Configuration)' == 'Server' and '$(DeploymentMode)' == 'Deploy' and '$(SettingsFilePath)' != ''" />

    <Message Text="Invalid settings file path." Condition="'$(SettingsFilePath)' == ''" Importance="normal" />
    <Message Text="Using settings file $(SettingsFilePath)" Condition="'$(SettingsFilePath)' != ''" />
  </Target>

  <Target Name="ExportSettings" DependsOnTargets="CustomPreExportSettings" Condition="'$(SkipExportSettings)' != 'true'">
    <PropertyGroup>
      <EffectiveSettingsSpreadsheetPath Condition="'$(Configuration)' == 'Server'">$(MSBuildProjectDirectory)\EnvironmentSettings\SettingsFileGenerator.xml</EffectiveSettingsSpreadsheetPath>
      <EffectiveSettingsSpreadsheetPath Condition="'$(Configuration)' != 'Server'">$(SettingsSpreadsheetPath)</EffectiveSettingsSpreadsheetPath>

      <EffectiveSettingsFilesExportPath Condition="'$(Configuration)' == 'Server'">$(MSBuildProjectDirectory)\EnvironmentSettings</EffectiveSettingsFilesExportPath>
      <EffectiveSettingsFilesExportPath Condition="'$(Configuration)' != 'Server'">$(SettingsFilesExportPath)</EffectiveSettingsFilesExportPath>
    </PropertyGroup>

    <Message
      Text="Skipping settings file export because file at SettingsSpreadsheetPath does not exist: $(EffectiveSettingsSpreadsheetPath)"
      Condition="!Exists('$(EffectiveSettingsSpreadsheetPath)')" />

    <Exec Command="&quot;$(DeployTools)\EnvironmentSettingsExporter.exe&quot; &quot;$(EffectiveSettingsSpreadsheetPath)&quot; &quot;$(EffectiveSettingsFilesExportPath)&quot;"
          ContinueOnError="false"
          Condition="Exists('$(EffectiveSettingsSpreadsheetPath)')" />
  </Target>

  <!-- ServerDeploy/ServerUndeploy are all about deploying binaries that arrive via MSI installation!
        Note that this target expects a property to have been defined - most likely on the command line -
        that defines whether we are supposed to deploy to the BizTalk management database or not, since
        that only has to happen once in a multi-server group -->
  <Target Name="ServerDeploy" DependsOnTargets="SetServerDeployProperties;LoadPropsFromEnvSettingsThenExecute" />

  <Target Name="SetServerDeployProperties">
    <PropertyGroup>
      <TargetsAfterLoadPropsFromEnvSettings>DeployBizTalkMgmtDB_$(DeployBizTalkMgmtDB)</TargetsAfterLoadPropsFromEnvSettings>
    </PropertyGroup>
  </Target>
  
  <!-- Note this target is consulting the deployBizTalkMgmtDB property, which is generally passed in on the command line,
        to determine whether we will be deploying to the biztalk management database. -->
  <Target Name="ServerUndeploy" DependsOnTargets="SetServerUndeployProperties;LoadPropsFromEnvSettingsThenExecute" />

  <Target Name="SetServerUndeployProperties">
    <PropertyGroup>
      <TargetsAfterLoadPropsFromEnvSettings>UndeployBizTalkMgmtDB_$(DeployBizTalkMgmtDB)</TargetsAfterLoadPropsFromEnvSettings>
    </PropertyGroup>
  </Target>

  <!-- Supports server deployments that include the BizTalk management database. -->
  <!-- In this case, do a full deployment. -->
  <Target Name="DeployBizTalkMgmtDB_true" DependsOnTargets="DevDeploy" />

  <PropertyGroup>
    <DeployBizTalkMgmtDBfalseDependsOn>
      CustomPreInitialize;
      FrameworkInitialize;
      CustomPostInitialize;
      _PreprocessBindings;
      PreprocessFiles;
      PreprocessAndConfigureLog4net;
      CustomDeployTarget;
      ConditionalHostStop;
      DeploySharedAssemblies;
      DeployExternalAssemblies;
      DeployComponents;
      DeployPipelineComponents;
      DeployCustomFunctoids;
      DeployVDirs;
      DeployBtsNtSvcExeConfig;
      CustomPostDeployTarget;
      CustomFinalDeploy
    </DeployBizTalkMgmtDBfalseDependsOn>
  </PropertyGroup>

  <!-- Used for a deployment that will NOT deploy assemblies to the BizTalk management database. 
        Only one server in a BizTalk group should actually deploy assemblies to the management database. -->
  <Target Name="DeployBizTalkMgmtDB_false" DependsOnTargets="$(DeployBizTalkMgmtDBfalseDependsOn)">
    <!-- Support server deployments that do not include BizTalk management database. -->
    <!-- Need to handle these differently than standard targets - just putting in gac... -->

    <Exec Command="&quot;$(Gacutil)&quot; /f /i &quot;@(SchemasQualified)&quot;" Condition="'$(IncludeSchemas)' == 'true' and '%(Identity)' == '%(Identity)'" />

    <Exec Command="&quot;$(Gacutil)&quot; /f /i &quot;@(PipelinesQualified)&quot;" Condition="'$(IncludePipelines)' == 'true' and '%(Identity)' == '%(Identity)'" />

    <Exec Command="&quot;$(Gacutil)&quot; /f /i &quot;@(TransformsQualified)&quot;" Condition="'$(IncludeTransforms)' == 'true' and '%(Identity)' == '%(Identity)'" />

    <Exec Command="&quot;$(Gacutil)&quot; /f /i &quot;@(OrchestrationsQualified)&quot;" Condition="'$(IncludeOrchestrations)' == 'true' and '%(Identity)' == '%(Identity)'" />
  </Target>

  <!-- Supports server undeployments that include undeploying from the BizTalk management database. -->
  <!-- In this case, do a standard deployment. -->
  <Target Name="UndeployBizTalkMgmtDB_true" DependsOnTargets="DevUndeploy" />

  <PropertyGroup>
    <UndeployBizTalkMgmtDBfalseDependsOn>
      CustomPreInitialize;
      FrameworkInitialize;
      CustomPostInitialize;
      CustomUndeployTarget;
      ConditionalHostStop;
      UndeploySharedAssemblies;
      UndeployExternalAssemblies;
      UndeployComponents;
      UndeployPipelineComponents;
      UndeployCustomFunctoids;
      UndeployVDirs;
      UndeployBtsNtSvcExeConfig;
      CustomPostUndeployTarget;
    </UndeployBizTalkMgmtDBfalseDependsOn>
  </PropertyGroup>

  <!-- Used for undeployment that will NOT undeploy assemblies from the BizTalk management database. 
        Only one server in a BizTalk group should undeploy assemblies to the management database. -->
  <Target Name="UndeployBizTalkMgmtDB_false" DependsOnTargets="$(UndeployBizTalkMgmtDBfalseDependsOn)">
    <!-- Support server undeployments that do not include Biztalk management database. -->
    <!-- Need to handle these differently than standard targets - just removing from gac... -->

    <!--
      Use the assembly's display name to remove the specific assembly from the GAC.
      If the version is not specified, gacutil removes all assemblies from the GAC that match on
      the filename, even if they have different strong names.
    -->
    <GenerateAssemblyNamesItemGroup SourceAssemblies="@(SchemasQualified)" Condition="'$(IncludeSchemas)' == 'true'">
      <Output TaskParameter="AssemblyNamesItemGroup" ItemName="SchemaAssemblyNamesGroup" />
    </GenerateAssemblyNamesItemGroup>

    <!-- When GACUTIL removes the assembly from the GAC, it will also remove the PDB file (copied when DeployPDBsToGac is enabled). -->
    <Exec Command="&quot;$(Gacutil)&quot; /u &quot;@(SchemaAssemblyNamesGroup)&quot;" Condition="%(Identity) == %(Identity) and '$(IncludeSchemas)' == 'true'" />


    <GenerateAssemblyNamesItemGroup SourceAssemblies="@(PipelinesQualified)" Condition="'$(IncludePipelines)' == 'true'">
      <Output TaskParameter="AssemblyNamesItemGroup" ItemName="PipelineAssemblyNamesGroup" />
    </GenerateAssemblyNamesItemGroup>

    <!-- When GACUTIL removes the assembly from the GAC, it will also remove the PDB file (copied when DeployPDBsToGac is enabled). -->
    <Exec Command="&quot;$(Gacutil)&quot; /u &quot;@(PipelineAssemblyNamesGroup)&quot;" Condition="%(Identity) == %(Identity) and '$(IncludePipelines)' == 'true'" />


    <GenerateAssemblyNamesItemGroup SourceAssemblies="@(TransformsQualified)" Condition="'$(IncludeTransforms)' == 'true'">
      <Output TaskParameter="AssemblyNamesItemGroup" ItemName="TransformAssemblyNamesGroup" />
    </GenerateAssemblyNamesItemGroup>

    <!-- When GACUTIL removes the assembly from the GAC, it will also remove the PDB file (copied when DeployPDBsToGac is enabled). -->
    <Exec Command="&quot;$(Gacutil)&quot; /u &quot;@(TransformAssemblyNamesGroup)&quot;" Condition="%(Identity) == %(Identity) and '$(IncludeTransforms)' == 'true'" />

    <GenerateAssemblyNamesItemGroup SourceAssemblies="@(OrchestrationsQualified)" Condition="'$(IncludeOrchestrations)' == 'true'">
      <Output TaskParameter="AssemblyNamesItemGroup" ItemName="OrchestrationAssemblyNamesGroup" />
    </GenerateAssemblyNamesItemGroup>

    <!-- When GACUTIL removes the assembly from the GAC, it will also remove the PDB file (copied when DeployPDBsToGac is enabled). -->
    <Exec Command="&quot;$(Gacutil)&quot; /u &quot;@(OrchestrationAssemblyNamesGroup)&quot;" Condition="%(Identity) == %(Identity) and '$(IncludeOrchestrations)' == 'true'" />
  </Target>

  <PropertyGroup>
    <_UpdateOrchestrationsDependsOn>
      InitUpdateOrchestration;
      CustomPreInitialize;
      FrameworkInitialize;
      CustomPostInitialize;
      TerminateServiceInstancesConditional;
      ConditionalHostStop;
      _DeploySSO;
      DeploySchemas;
      DeployExternalAssemblies;
      DeployComponents;
      DeployPipelines;
      DeployPipelineComponents;
      DeployTransforms;
      DeployOrchestrations;
      DeployCustomFunctoids;
      DeployEsbItineraries;
      _BounceBizTalk
    </_UpdateOrchestrationsDependsOn>
  </PropertyGroup>

  <Target Name="InitUpdateOrchestration">
    <PropertyGroup>
      <DeployBizTalkMgmtDB>false</DeployBizTalkMgmtDB>
    </PropertyGroup>
  </Target>

  <!-- If you haven't changed any of the ports in your orchestration, you can simply replace the orchestration
       assembly in the GAC and bounce the service. This is much faster than a full redeploy, and speeds the
       edit/run/debug cycle. A similar thing can be done for components assembly, SSO config and others. -->
  <Target Name="UpdateOrchestration" DependsOnTargets="SetUpdateOrchestrationProperties;LoadPropsFromEnvSettingsThenExecute" />

  <Target Name="SetUpdateOrchestrationProperties">
    <PropertyGroup>
      <TargetsAfterLoadPropsFromEnvSettings>_UpdateOrchestration</TargetsAfterLoadPropsFromEnvSettings>
    </PropertyGroup>
  </Target>

  <Target Name="_UpdateOrchestration" DependsOnTargets="$(_UpdateOrchestrationsDependsOn)" />

  <PropertyGroup>
    <DeployDependsOn>
      CustomPreInitialize;
      FrameworkInitialize;
      CustomPostInitialize;
      _PreprocessBindings;
      PreprocessFiles;
      PreprocessAndConfigureLog4net;
      DeployFileAdapterPhysicalPaths;
      CustomDeployTarget;
      DeployAppDefinition;
      ConditionalHostStop;
      DeploySharedAssemblies;
      _DeploySSO;
      DeploySchemas;
      DeployExternalAssemblies;
      DeployComponents;
      DeployPipelineComponents;
      DeployPipelines;
      DeployTransforms;
      DeployOrchestrations;
      _ImportBindings;
      DeployVDirs;
      _DeployVocabAndRules;
      DeployCustomFunctoids;
      DeployEsbItineraries;
      DeployBtsNtSvcExeConfig;
      DeployBam;
      CustomPostDeployTarget;
      _BounceBizTalk;
      StartApplication;
      CustomFinalDeploy
    </DeployDependsOn>

    <UndeployDependsOn>
      CustomPreInitialize;
      FrameworkInitialize;
      CustomPostInitialize;
      CustomUndeployTarget;
      PrepareAppForUndeploy;
      ConditionalHostStop;
      UndeployBam;
      UndeployBtsNtSvcExeConfig;
      UndeployEsbItineraries;
      UndeploySchemas;
      UndeployOrchestrations;
      UndeployTransforms;
      UndeployPipelines;
      UndeployPipelineComponents;
      UndeployComponents;
      UndeployExternalAssemblies;
      UndeploySharedAssemblies;
      UndeployVDirs;
      _UndeployVocabAndRules;
      UndeployCustomFunctoids;
      UndeploySSO;
      UndeployAppDefinition;
      UndeployFileAdapterPhysicalPaths;
      CustomPostUndeployTarget;
      _BounceBizTalk;
      CustomFinalUndeploy
    </UndeployDependsOn>
  </PropertyGroup>

  <!-- Master dependency list for deploying, including BizTalk management database. -->
  <Target Name="DevDeploy" DependsOnTargets="$(DeployDependsOn)" />

  <!-- Master dependency list for undeploying, including BizTalk management database. -->
  <Target Name="DevUndeploy" DependsOnTargets="$(UndeployDependsOn)" />

  <Target Name="Deploy" DependsOnTargets="SetDeployProperties;LoadPropsFromEnvSettingsThenExecute" />

  <Target Name="SetDeployProperties">
    <PropertyGroup>
      <DeploymentMode>Deploy</DeploymentMode>
    </PropertyGroup>

    <Message Text="DEPLOYING APPLICATION TO BIZTALK..." />

    <PropertyGroup>
      <TargetsAfterLoadPropsFromEnvSettings Condition="'$(Configuration)' != 'Server'">DevDeploy</TargetsAfterLoadPropsFromEnvSettings>
      <TargetsAfterLoadPropsFromEnvSettings Condition="'$(Configuration)' == 'Server'">ServerDeploy</TargetsAfterLoadPropsFromEnvSettings>
    </PropertyGroup>
  </Target>

  <Target Name="Undeploy" DependsOnTargets="SetUndeployProperties;LoadPropsFromEnvSettingsThenExecute" />
  
  <Target Name="SetUndeployProperties">
    <PropertyGroup>
      <DeploymentMode>Undeploy</DeploymentMode>
    </PropertyGroup>

    <Message Text="UNDEPLOYING APPLICATION FROM BIZTALK..." />

    <PropertyGroup >
      <TargetsAfterLoadPropsFromEnvSettings Condition="'$(Configuration)' != 'Server'">DevUndeploy</TargetsAfterLoadPropsFromEnvSettings>
      <TargetsAfterLoadPropsFromEnvSettings Condition="'$(Configuration)' == 'Server'">ServerUndeploy</TargetsAfterLoadPropsFromEnvSettings>
    </PropertyGroup>
  </Target>

  <Target Name="DeployFileAdapterPhysicalPaths" Condition="'$(ManageFileAdapterPhysicalPaths)' == 'true' and '$(IncludeMessagingBindings)' == 'true'">
    <SetUpFileAdapterPaths BindingFilePath="$(PortBindings)" UserNameForFullControl="BUILTIN\Users" Mode="SetUp" Condition="'$(Configuration)' != 'Server'" />

    <Message Text="The BTSACCOUNT environment variable must be set up in InstallWizard.xml for automatic configuration of permissions for FILE adapter physical paths." Condition="'$(Configuration)' == 'Server' and '$(BTSACCOUNT)' == ''" />
    <SetUpFileAdapterPaths BindingFilePath="$(PortBindings)" UserNameForFullControl="$(BTSACCOUNT)" Mode="SetUp" Condition="'$(Configuration)' == 'Server'" />
  </Target>

  <Target Name="UndeployFileAdapterPhysicalPaths" Condition="'$(ManageFileAdapterPhysicalPaths)' == 'true' and '$(DeleteFileAdapterPhysicalPathsOnUndeploy)' != 'Never' and '$(IncludeMessagingBindings)' == 'true'">
    <SetUpFileAdapterPaths BindingFilePath="$(PortBindings)" Mode="$(DeleteFileAdapterPhysicalPathsOnUndeploy)" />
  </Target>

  <Target Name="DeployBtsNtSvcExeConfig">
    <UpdateBizTalkAppDomainConfig
      AppDomainName="$(BizTalkAppName)" PatternAssignmentRules="@(AllPatternAssignmentRule)" AppDomains="@(BizTalkAppDomain)" DefaultAssemblyNameRegexes="$(BizTalkAppDomainAssemblyNameRegexesDefault)"
      Condition="'$(UseIsolatedAppDomain)' == 'true'" />
    <UpdateBizTalkDebuggingConfig
      ValidateAssemblies="$(EnableBizTalkAssemblyValidation)" ValidateSchemas="$(EnableBizTalkSchemaValidation)"
      ValidateCorrelations="$(EnableBizTalkCorrelationValidation)" ExtendedLogging="$(EnableBizTalkExtendedLogging)"
      Condition="'$(ConfigureBizTalkDebuggingFeatures)' == 'true'" />
  </Target>

  <Target Name="UndeployBtsNtSvcExeConfig">
    <UpdateBizTalkAppDomainConfig AppDomainName="$(BizTalkAppName)" Remove="true" Condition="'$(UseIsolatedAppDomain)' == 'true'" />
  </Target>

  <Target Name="SetPropertiesFromEnvironmentSettings" Condition="'@(PropsFromEnvSettings)' != '' and '$(LoadedPropsFromEnvSettings)' != 'true'" DependsOnTargets="InitSettingsFilePath">
    <!--
      Takes an ItemGroup of property names and obtains their values from the settings file
      specified in $(ENV_SETTINGS), typically passed by SetEnvUI.
    -->

    <Message Text="Setting properties from environment settings file ($(SettingsFilePath))"
             Condition="'$(SettingsFilePath)' != '' and Exists('$(SettingsFilePath)')" />

    <SetPropFromEnvSetting
      SettingsFilePath="$(SettingsFilePath)"
      XPath="/settings/property[@name='@(PropsFromEnvSettings)']"
      PropertyName="@(PropsFromEnvSettings)"
      Identity="%(Identity)"
      Condition="'$(SettingsFilePath)' != '' and Exists('$(SettingsFilePath)')">
      <Output TaskParameter="Value" PropertyName="@(PropsFromEnvSettings)" />
    </SetPropFromEnvSetting>

    <GetPropsFromEnvSettingsDelimited
      SettingsFilePath="$(SettingsFilePath)"
      XPathTemplate="/settings/property[@name='@@NAME@@']"
      PropertyNames="@(PropsFromEnvSettings)"
      Condition="'$(SettingsFilePath)' != '' and Exists('$(SettingsFilePath)')">
      <Output TaskParameter="Value" PropertyName="PropsFromEnvSettingsDelimited" />
    </GetPropsFromEnvSettingsDelimited>
  </Target>

  <!-- Since host instance processes will be hanging on to DLLs... -->
  <Target Name="ConditionalHostStop" Condition="'$(DeployPDBsToGac)' == 'true' and '$(SkipUndeploy)' == 'false'" DependsOnTargets="StopBizTalk" />

  <!-- Reset BizTalk hosts and IIS -->
  <!-- An iisreset is needed with http & the isolated host since your binaries will be loaded into IIS processes -->
  <Target Name="_BounceBizTalk">
    <CallTarget Targets="ResetIIS" />
    <CallTarget Targets="BounceAllBizTalkHosts" />
    <CallTarget Targets="BounceSelectedBizTalkHosts" />

    <Pause Message="Press a key to continue..." Condition="'$(Interactive)' == 'true'" />

    <OnError ExecuteTargets="PauseForError" />
  </Target>
  
  <Target Name="BounceBizTalk" DependsOnTargets="SetBounceBizTalkProperties;LoadPropsFromEnvSettingsThenExecute" />

  <Target Name="SetBounceBizTalkProperties">
    <PropertyGroup>
      <TargetsAfterLoadPropsFromEnvSettings>_BounceBizTalk</TargetsAfterLoadPropsFromEnvSettings>
    </PropertyGroup>
  </Target>

  <Target Name="StopBizTalk">
    <!-- An iisreset is needed with http & the isolated host, since your binaries will be loaded into IIS processes -->
    <Exec Command="iisreset.exe /noforce /restart /timeout:$(IisResetTime)" Condition="'$(SkipIISReset)' == 'false' and '@(IISAppPool)' == ''" />
    <RecycleAppPool Items="@(IISAppPool)" Condition="'$(SkipIISReset)' == 'false' and '@(IISAppPool)' != ''" />

    <CallTarget Targets="StopAllBizTalkHosts" Condition="'@(BizTalkHosts)' == ''" />
    <CallTarget Targets="StopSelectedBizTalkHosts" Condition="'@(BizTalkHosts)' != ''" />
  </Target>

  <Target Name="StopAllBizTalkHosts">
    <Message Text="Host list (BizTalkHosts ItemGroup) not customized." />
    <ControlBizTalkHostInstance Mode="Stop" />
  </Target>

  <Target Name="StopSelectedBizTalkHosts">
    <ControlBizTalkHostInstance Mode="Stop" HostNames="@(BizTalkHosts)" />
  </Target>

  <Target Name="BounceAllBizTalkHosts" Condition="'@(BizTalkHosts)' == '' and '$(SkipHostInstancesRestart)' != 'true'">
    <Message Text="Host list (BizTalkHosts ItemGroup) not customized." />
    <ControlBizTalkHostInstance Mode="Restart" />
  </Target>

  <Target Name="BounceSelectedBizTalkHosts" Condition="'@(BizTalkHosts)' != '' and '$(SkipHostInstancesRestart)' != 'true'">
    <ControlBizTalkHostInstance Mode="Restart" HostNames="@(BizTalkHosts)" />
  </Target>
  
  <Target Name="ResetIIS" Condition="'$(SkipIISReset)' == 'false'">
    <Exec Command="iisreset.exe /noforce /restart /timeout:$(IisResetTime)" Condition="'@(IISAppPool)' == ''" />
    <RecycleAppPool Items="@(IISAppPool)" Condition="'@(IISAppPool)' != ''" />
  </Target>

  <PropertyGroup>
    <_PreprocessBindingsDependsOn>
      InitSettingsFilePath;
      CustomPreExportSettings;
      ExportSettings;
      CustomPostExportSettings;
      SetPropertiesFromEnvironmentSettings;
      PreprocessFiles;
    </_PreprocessBindingsDependsOn>
  </PropertyGroup>

  <Target Name="_PreprocessBindings" Condition="'$(IncludeMessagingBindings)' == 'true'" DependsOnTargets="$(_PreprocessBindingsDependsOn)">
    <CheckXmlSyntax XmlFilenames="$(MSBuildProjectDirectory)\$(SourceBindingFile)" />

    <!-- in case readonly from version control -->
    <MakeFilesWriteable InputFiles="@(PortBindingsFile)" />
    <Exec
      Command="&quot;$(DeployTools)\xmlpreprocess.exe&quot; /v /c /i:&quot;$(MSBuildProjectDirectory)\$(SourceBindingFile)&quot; /o:&quot;$(MSBuildProjectDirectory)\$(PortBindings)&quot; /d:CurDir=&quot;$(MSBuildProjectDirectoryParent)&quot; /s:&quot;$(SettingsFilePath)&quot;"
      ContinueOnError="false" Condition="'$(EnableXmlPreprocess)' == 'true' and '$(RequireXmlPreprocessDirectives)' == 'true'" />
    <Exec
      Command="&quot;$(DeployTools)\xmlpreprocess.exe&quot; /v /c /noDirectives /i:&quot;$(MSBuildProjectDirectory)\$(SourceBindingFile)&quot; /o:&quot;$(MSBuildProjectDirectory)\$(PortBindings)&quot; /d:CurDir=&quot;$(MSBuildProjectDirectoryParent)&quot; /s:&quot;$(SettingsFilePath)&quot;"
      ContinueOnError="false" Condition="'$(EnableXmlPreprocess)' == 'true' and '$(RequireXmlPreprocessDirectives)' == 'false'" />

    <!-- Update the app name in the bindings file -->
    <WriteXmlValue XmlFilenames="$(PortBindings)" XPath="//ApplicationName" Value="$(BizTalkAppName)" />

    <PrependToBindingPortNames StringToPrepend="$(BizTalkAppName)" BindingFilePath="$(MSBuildProjectDirectory)\$(PortBindings)" Condition="'$(EnableSideBySide)' == 'true' and '$(DisableAutomaticPortNameVersioning)' == 'false'" />

    <Exec
      Command="&quot;$(DeployTools)\ElementTunnel.exe&quot; /i:&quot;$(MSBuildProjectDirectory)\$(PortBindings)&quot; /o:&quot;$(MSBuildProjectDirectory)\$(PortBindings)&quot; /x:&quot;$(XmlEscapeXPathsFile)&quot; /encode+"
      ContinueOnError="false"
      Condition="'$(ApplyXmlEscape)' == 'true'" />

    <CheckXmlSyntax XmlFilenames="$(MSBuildProjectDirectory)\$(PortBindings)" />
  </Target>
  
  <Target Name="PreprocessBindings" Condition="'$(IncludeMessagingBindings)' == 'true'" DependsOnTargets="SetPreprocessBindingsProperties;LoadPropsFromEnvSettingsThenExecute" />

  <Target Name="SetPreprocessBindingsProperties">
    <PropertyGroup>
      <TargetsAfterLoadPropsFromEnvSettings>_PreprocessBindings</TargetsAfterLoadPropsFromEnvSettings>
    </PropertyGroup>
  </Target>

  <Target Name="PreprocessAndConfigureLog4net" DependsOnTargets="InitSettingsFilePath" Condition="'$(Includelog4net)' == 'true'">
    <!-- in case readonly from version control -->
    <MakeFilesWriteable InputFiles="@(Log4netFile)" Condition="'$(EnableXmlPreprocess)' == 'true'" />
    <Exec
	    Command="&quot;$(DeployTools)\xmlpreprocess.exe&quot; /v /c /i:&quot;@(Log4netFile)&quot; /o:&quot;@(Log4netFile)&quot; /d:CurDir=&quot;$(MSBuildProjectDirectoryParent)&quot; /s:&quot;$(SettingsFilePath)&quot;"
	    ContinueOnError="false" Condition="'$(EnableXmlPreprocess)' == 'true' and '$(RequireXmlPreprocessDirectives)' == 'true'" />
    <Exec
	    Command="&quot;$(DeployTools)\xmlpreprocess.exe&quot; /v /c /noDirectives /i:&quot;@(Log4netFile)&quot; /o:&quot;@(Log4netFile)&quot; /d:CurDir=&quot;$(MSBuildProjectDirectoryParent)&quot; /s:&quot;$(SettingsFilePath)&quot;"
	    ContinueOnError="false" Condition="'$(EnableXmlPreprocess)' == 'true' and '$(RequireXmlPreprocessDirectives)' == 'false'" />

    <!-- Write registry key with location of our log4net configuration file. -->
    <Message Text="Adding log4net registry keys..." />
    <SetRegistryValue KeyName="$(Log4netRegKey)" ValueName=" " Value="@(Log4netFile)" />
    <Message Text="Finished adding log4net registry keys." />
  </Target>

  <Target Name="PreprocessFiles" DependsOnTargets="InitSettingsFilePath" Condition="'@(FilesToXmlPreprocess)' != '' and '$(EnableXmlPreprocess)' == 'true'">
    <!-- This logic is backwards compatible with FilesToXmlPreprocess ItemGroups that do not include OutputFilename metadata. -->

    <!-- In case files exist and are read-only -->
    <MakeFilesWriteable InputFiles="@(FilesToXmlPreprocessQualified)"
      Condition="'%(FilesToXmlPreprocessQualified.OutputFilename)' == ''" />
    <MakeFilesWriteable InputFiles="@(FilesToXmlPreprocessQualified->'%(RootDir)%(Directory)%(OutputFilename)')"
      Condition="'%(FilesToXmlPreprocessQualified.OutputFilename)' != ''" />

    <PropertyGroup>
      <XmlPreprocessDirectivesSwitch Condition="'$(RequireXmlPreprocessDirectives)' == 'false'">/noDirectives</XmlPreprocessDirectivesSwitch>
    </PropertyGroup>

    <Exec
	    Command="&quot;$(DeployTools)\xmlpreprocess.exe&quot; /v /c $(XmlPreprocessDirectivesSwitch) /i:&quot;@(FilesToXmlPreprocessQualified)&quot; /o:&quot;@(FilesToXmlPreprocessQualified)&quot; /d:CurDir=&quot;$(MSBuildProjectDirectoryParent)&quot; /s:&quot;$(SettingsFilePath)&quot;"
	    ContinueOnError="false"
      Condition="%(Identity) == %(Identity) and '%(FilesToXmlPreprocessQualified.OutputFilename)' == ''"/>
    <Exec
	    Command="&quot;$(DeployTools)\xmlpreprocess.exe&quot; /v /c $(XmlPreprocessDirectivesSwitch) /i:&quot;@(FilesToXmlPreprocessQualified)&quot; /o:&quot;@(FilesToXmlPreprocessQualified->'%(RootDir)%(Directory)%(OutputFilename)')&quot; /d:CurDir=&quot;$(MSBuildProjectDirectoryParent)&quot; /s:&quot;$(SettingsFilePath)&quot;"
	    ContinueOnError="false"
      Condition="%(Identity) == %(Identity) and '%(FilesToXmlPreprocessQualified.OutputFilename)' != ''"/>
  </Target>

  <!-- Redefine in project file if required -->
  <!-- DEPRECATED: Use Target's BeforeTargets and AfterTargets attributes instead -->
  <Target Name="CustomPreInitialize" />
  <Target Name="CustomPostInitialize" />
  <Target Name="CustomPreExportSettings" />
  <Target Name="CustomPostExportSettings" />
  <Target Name="CustomDeployTarget" />
  <Target Name="CustomUndeployTarget" />
  <Target Name="CustomPostDeployTarget" />
  <Target Name="CustomPostUndeployTarget" />
  <Target Name="CustomFinalDeploy" />
  <Target Name="CustomFinalUndeploy" />
  <Target Name="CustomSSO" />

  <Target Name="DeployAppDefinition" DependsOnTargets="UndeployAppDefinition">
    <!--<Exec Command="BTSTask.exe AddApp -ApplicationName:&quot;$(BizTalkAppName)&quot; -Description:&quot;$(BizTalkAppDescription)&quot;" /> Change! -->
    <AddAppReference ApplicationName="$(BizTalkAppName)" AppsToReference="@(AppsToReference)" Condition="%(Identity) == %(Identity) and '@(AppsToReference)' != ''" />
  </Target>

  <Target Name="PrepareAppForUndeploy" DependsOnTargets="VerifyBizTalkAppExists">
    <Error Text="BizTalk application '$(BizTalkAppName)' does not exist in the group, so there is nothing to do."
           Condition="'$(AppExists)' == 'false' and '$(DeploymentMode)' == 'Undeploy'" />

    <CallTarget Targets="StopApplication" />
    <CallTarget Targets="TerminateServiceInstancesConditional" />
    <CheckForServiceInstances Application="$(BizTalkAppName)" Condition="'$(AppExists)' == 'true'" />
  </Target>

  <Target Name="UndeployAppDefinition" Condition="'$(SkipUndeploy)' == 'false'" DependsOnTargets="PrepareAppForUndeploy">
    <Exec Command="BTSTask.exe RemoveApp -ApplicationName:&quot;$(BizTalkAppName)&quot;" Condition="'$(AppExists)' == 'true'" ContinueOnError="true"/>
  </Target>

  <Target Name="DeploySchemas" DependsOnTargets="UndeploySchemas" Condition="'$(IncludeSchemas)' == 'true'">
    <Exec
      Command="BTSTask.exe AddResource -Type:BizTalkAssembly -Overwrite -Source:&quot;@(SchemasQualified)&quot; -ApplicationName:&quot;$(BizTalkAppName)&quot; -Options:GacOnAdd,GacOnImport,GacOnInstall"
      Condition="'$(DeployBizTalkMgmtDB)' == 'true' and '%(Identity)' == '%(Identity)'" />

    <Exec Command="&quot;$(Gacutil)&quot; /f /i &quot;@(SchemasQualified)&quot;"
          Condition="'$(DeployBizTalkMgmtDB)' == 'false' and '%(Identity)' == '%(Identity)'" />
  </Target>

  <Target Name="UndeploySchemas"
     DependsOnTargets="UndeployOrchestrations;UndeployTransforms" Condition="'$(IncludeSchemas)' == 'true' and '$(SkipUndeploy)' != 'true'">
    <!--
      Use the assembly's display name to remove the specific assembly from the GAC.
      If the version is not specified, gacutil removes all assemblies from the GAC that match on
      the filename, even if they have different strong names.
    -->
    <GenerateAssemblyNamesItemGroup SourceAssemblies="@(SchemasQualified)">
      <Output TaskParameter="AssemblyNamesItemGroup" ItemName="SchemaAssemblyNamesGroup" />
    </GenerateAssemblyNamesItemGroup>

    <!-- When GACUTIL removes the assembly from the GAC, it will also remove the PDB file (copied when DeployPDBsToGac is enabled). -->
    <Exec Command="&quot;$(Gacutil)&quot; /u &quot;@(SchemaAssemblyNamesGroup)&quot;" Condition="'%(Identity)' == '%(Identity)'" />
  </Target>

  <Target Name="DeployOrchestrations" Condition="'$(IncludeOrchestrations)' == 'true'">
    <!-- Deploy orchestration assemblies. -->

    <Exec
      Command="BTSTask.exe AddResource -Type:BizTalkAssembly -Overwrite -Source:&quot;@(OrchestrationsQualified)&quot; -ApplicationName:&quot;$(BizTalkAppName)&quot; -Options:GacOnAdd,GacOnImport,GacOnInstall"
      Condition="%(Identity) == %(Identity) and '$(DeployBizTalkMgmtDB)' == 'true'" />

    <Exec Command="&quot;$(Gacutil)&quot; /f /i &quot;@(OrchestrationsQualified)&quot;"
          Condition="%(Identity) == %(Identity) and '$(DeployBizTalkMgmtDB)' == 'false'" />

    <!-- Deploy PDBS to gac -->
    <GeneratePdbCopyItemGroups SourceAssemblies="@(OrchestrationsQualified)" Condition="'$(DeployPDBsToGac)' == 'true'">
      <Output TaskParameter="SourceItemGroup" ItemName="OrchestrationsPdbSourceFilesGroup" />
      <Output TaskParameter="DestinationItemGroup" ItemName="OrchestrationsPdbDestinationFilesGroup" />
    </GeneratePdbCopyItemGroups>
    <Copy SourceFiles="@(OrchestrationsPdbSourceFilesGroup)" DestinationFiles="@(OrchestrationsPdbDestinationFilesGroup)" Condition="'$(DeployPDBsToGac)' == 'true'"
          ContinueOnError="true" />
  </Target>

  <Target Name="UndeployOrchestrations" Condition="'$(IncludeOrchestrations)' == 'true' and '$(SkipUndeploy)' == 'false'">
    <!-- Undeploy orchestration assemblies. -->

    <!--
      Use the assembly's display name to remove the specific assembly from the GAC.
      If the version is not specified, gacutil removes all assemblies from the GAC that match on
      the filename, even if they have different strong names.
    -->
    <GenerateAssemblyNamesItemGroup SourceAssemblies="@(OrchestrationsQualified)">
      <Output TaskParameter="AssemblyNamesItemGroup" ItemName="OrchestrationAssemblyNamesGroup" />
    </GenerateAssemblyNamesItemGroup>

    <!-- When GACUTIL removes the assembly from the GAC, it will also remove the PDB file (copied when DeployPDBsToGac is enabled). -->
    <Exec Command="&quot;$(Gacutil)&quot; /u &quot;@(OrchestrationAssemblyNamesGroup)&quot;" Condition="%(Identity) == %(Identity)" />
  </Target>

  <Target Name="DeploySharedAssemblies" Condition="'@(AdditionalAssemblies)' != ''">
    <!--
      Deploy additional assemblies.  We aren't undeploying them since they are shared components,
      though this could be debated.
    -->
    <Message Text="Deploying additional assemblies to GAC..." />
    <Exec
      Command="&quot;$(Gacutil)&quot; /f /i &quot;@(AdditionalAssemblies->'$(DeployTools)\%(Identity)')&quot;"
      Condition="%(Identity) == %(Identity)" />
    <Message Text="Finished deploying additional assemblies to GAC." />
  </Target>

  <Target Name="UndeploySharedAssemblies" Condition="'@(AdditionalAssemblies)' != ''">
    <!-- Since these are shared we do not undeploy them... could be debated. -->
  </Target>

  <Target Name="DeployExternalAssemblies" Condition="'@(ExternalAssemblies)' != ''">
    <Message Text="Deploying external assemblies..." />
    <Exec
      Command="&quot;$(Gacutil)&quot; /f /i &quot;@(ExternalAssembliesQualified)&quot;"
      Condition="'%(Identity)' == '%(Identity)'" />
    <Message Text="Finished deploying external assemblies." />
  </Target>

  <Target Name="UndeployExternalAssemblies" Condition="'@(ExternalAssemblies)' != ''">
    <!--
      Use the assembly's display name to remove the specific assembly from the GAC.
      If the version is not specified, gacutil removes all assemblies from the GAC that match on
      the filename, even if they have different strong names.
    -->
    <GenerateAssemblyNamesItemGroup SourceAssemblies="@(ExternalAssembliesQualified)" Condition="'$(UndeployExternalAssemblies)' == 'true'">
      <Output TaskParameter="AssemblyNamesItemGroup" ItemName="ExternalAssembliesAssemblyNamesGroup" />
    </GenerateAssemblyNamesItemGroup>

    <Exec Command="&quot;$(Gacutil)&quot; /u &quot;@(ExternalAssembliesAssemblyNamesGroup)&quot;" Condition="'@(ExternalAssembliesAssemblyNamesGroup)' != '' and '$(UndeployExternalAssemblies)' == 'true' and %(Identity) == %(Identity)" />
  </Target>

  <!-- This target uses a collection (comma separated list) of component assemblies in the components property.  Likewise for undeployComponents.  -->
  <Target Name="DeployComponents" Condition="'$(IncludeComponents)' == 'true'">
    <Message Text="Deploying components to GAC..." />
    <Exec Command="&quot;$(Gacutil)&quot; /f /i &quot;@(ComponentsQualified)&quot;" Condition="%(Identity) == %(Identity)" />
    <Message Text="Finished deploying components to GAC." />

    <!-- Deploy PDBS to GAC. -->
    <Message Text="Deploying PDB's to GAC..." Condition="'$(DeployPDBsToGac)' == 'true'" />
    <GeneratePdbCopyItemGroups SourceAssemblies="@(ComponentsQualified)" Condition="'$(DeployPDBsToGac)' == 'true'">
      <Output TaskParameter="SourceItemGroup" ItemName="ComponentsPdbSourceFilesGroup" />
      <Output TaskParameter="DestinationItemGroup" ItemName="ComponentsPdbDestinationFilesGroup" />
    </GeneratePdbCopyItemGroups>
    <Copy
      SourceFiles="@(ComponentsPdbSourceFilesGroup)" DestinationFiles="@(ComponentsPdbDestinationFilesGroup)"
      Condition="'$(DeployPDBsToGac)' == 'true'" ContinueOnError="true" />
    <Message Text="Finished deploying PDB's to GAC." Condition="'$(DeployPDBsToGac)' == 'true'" />

    <Message Text="Running installutil.exe on components..." Condition="'$(IncludeInstallUtilForComponents)' == 'true'" />
    <Exec
      Command="$(FrameworkDir)\installutil.exe /ShowCallStack &quot;@(ComponentsQualified)&quot;"
      Condition="'$(IncludeInstallUtilForComponents)' == 'true' and %(Identity) == %(Identity)" />
    <Message Text="Finished running installutil.exe on components." Condition="'$(IncludeInstallUtilForComponents)' == 'true'" />
  </Target>

  <Target Name="UndeployComponents" Condition="'$(IncludeComponents)' == 'true' and '$(SkipUndeploy)' == 'false'">
    <!--
      Use the assembly's display name to remove the specific assembly from the GAC.
      If the version is not specified, gacutil removes all assemblies from the GAC that match on
      the filename, even if they have different strong names.
    -->
    <GenerateAssemblyNamesItemGroup SourceAssemblies="@(ComponentsQualified)">
      <Output TaskParameter="AssemblyNamesItemGroup" ItemName="ComponentAssemblyNamesGroup" />
    </GenerateAssemblyNamesItemGroup>

    <!-- When GACUTIL removes the assembly from the GAC, it will also remove the PDB file (copied when DeployPDBsToGac is enabled). -->
    <Exec Command="&quot;$(Gacutil)&quot; /u &quot;@(ComponentAssemblyNamesGroup)&quot;" Condition="%(Identity) == %(Identity)" />

    <Exec
      Command="$(FrameworkDir)\installutil.exe /u /ShowCallStack &quot;@(ComponentsQualified)&quot;"
      Condition="'$(IncludeInstallUtilForComponents)' == 'true' and %(Identity) == %(Identity)" />
  </Target>

  <Target Name="DeployPipelines" Condition="'$(IncludePipelines)' == 'true'" DependsOnTargets="UndeployPipelines">
    <Exec
      Command="BTSTask.exe AddResource -Type:BizTalkAssembly -Overwrite -Source:&quot;@(PipelinesQualified)&quot; -ApplicationName:&quot;$(BizTalkAppName)&quot; -Options:GacOnAdd,GacOnImport,GacOnInstall"
      Condition="%(Identity) == %(Identity) and '$(DeployBizTalkMgmtDB)' == 'true'" />

    <Exec Command="&quot;$(Gacutil)&quot; /f /i &quot;@(PipelinesQualified)&quot;"
          Condition="%(Identity) == %(Identity) and '$(DeployBizTalkMgmtDB)' == 'false'" />

    <!-- Deploy PDBS to gac -->
    <GeneratePdbCopyItemGroups SourceAssemblies="@(PipelinesQualified)" Condition="'$(DeployPDBsToGac)' == 'true'">
      <Output TaskParameter="SourceItemGroup" ItemName="PipelinesPdbSourceFilesGroup" />
      <Output TaskParameter="DestinationItemGroup" ItemName="PipelinesPdbDestinationFilesGroup" />
    </GeneratePdbCopyItemGroups>
    <Copy SourceFiles="@(PipelinesPdbSourceFilesGroup)" DestinationFiles="@(PipelinesPdbDestinationFilesGroup)" Condition="'$(DeployPDBsToGac)' == 'true'"
          ContinueOnError="true" />
  </Target>

  <Target Name="UndeployPipelines" DependsOnTargets="UndeployOrchestrations" Condition="'$(IncludePipelines)' == 'true' and '$(SkipUndeploy)' == 'false'">
    <!--
      Use the assembly's display name to remove the specific assembly from the GAC.
      If the version is not specified, gacutil removes all assemblies from the GAC that match on
      the filename, even if they have different strong names.
    -->
    <GenerateAssemblyNamesItemGroup SourceAssemblies="@(PipelinesQualified)">
      <Output TaskParameter="AssemblyNamesItemGroup" ItemName="PipelineAssemblyNamesGroup" />
    </GenerateAssemblyNamesItemGroup>

    <!-- When GACUTIL removes the assembly from the GAC, it will also remove the PDB file (copied when DeployPDBsToGac is enabled). -->
    <Exec Command="&quot;$(Gacutil)&quot; /u &quot;@(PipelineAssemblyNamesGroup)&quot;" Condition="%(Identity) == %(Identity)" />
  </Target>

  <Target Name="DeployPipelineComponents" Condition="'$(IncludePipelineComponents)' == 'true'">
    <Copy SourceFiles="@(PipelineComponentsQualified)" DestinationFolder="$(BtsDir)Pipeline Components" ContinueOnError="true" />

    <Exec Command="&quot;$(Gacutil)&quot; /f /i &quot;@(PipelineComponentsQualified)&quot;" Condition="%(Identity) == %(Identity)" />

    <!-- Deploy PDBS to gac. -->
    <GeneratePdbCopyItemGroups SourceAssemblies="@(PipelineComponentsQualified)" Condition="'$(DeployPDBsToGac)' == 'true'">
      <Output TaskParameter="SourceItemGroup" ItemName="PipelineComponentsPdbSourceFilesGroup" />
      <Output TaskParameter="DestinationItemGroup" ItemName="PipelineComponentsPdbDestinationFilesGroup" />
    </GeneratePdbCopyItemGroups>
    <Copy SourceFiles="@(PipelineComponentsPdbSourceFilesGroup)" DestinationFiles="@(PipelineComponentsPdbDestinationFilesGroup)" Condition="'$(DeployPDBsToGac)' == 'true'"
          ContinueOnError="true" />
  </Target>

  <Target Name="UndeployPipelineComponents" Condition="'$(IncludePipelineComponents)' == 'true' and '$(SkipUndeploy)' == 'false'">
    <!-- To deal with pipeline components loaded in isolated host. -->
    <CallTarget Targets="ResetIIS" />

    <!-- Delete pipeline component assemblies from BizTalk's Pipeline Components folder. -->
    <Delete Files="@(PipelineComponents->'$(BtsDir)Pipeline Components\%(Identity)')" ContinueOnError="true" />

    <!-- Remove pipeline component assemblies from the GAC. -->
    <!--
      Use the assembly's display name to remove the specific assembly from the GAC.
      If the version is not specified, gacutil removes all assemblies from the GAC that match on
      the filename, even if they have different strong names.
    -->
    <GenerateAssemblyNamesItemGroup SourceAssemblies="@(PipelineComponentsQualified)">
      <Output TaskParameter="AssemblyNamesItemGroup" ItemName="PipelineComponentAssemblyNamesGroup" />
    </GenerateAssemblyNamesItemGroup>

    <!-- When GACUTIL removes the assembly from the GAC, it will also remove the PDB file (copied when DeployPDBsToGac is enabled). -->
    <Exec Command="&quot;$(Gacutil)&quot; /u &quot;@(PipelineComponentAssemblyNamesGroup)&quot;" Condition="%(Identity) == %(Identity)" />
  </Target>

  <Target Name="DeployTransforms" DependsOnTargets="UndeployTransforms" Condition="'$(IncludeTransforms)' == 'true'">
    <Exec
      Command="BTSTask.exe AddResource -Type:BizTalkAssembly -Overwrite -Source:&quot;@(TransformsQualified)&quot; -ApplicationName:&quot;$(BizTalkAppName)&quot; -Options:GacOnAdd,GacOnImport,GacOnInstall"
      Condition="%(Identity) == %(Identity) and '$(DeployBizTalkMgmtDB)' == 'true'" />

    <Exec Command="&quot;$(Gacutil)&quot; /f /i &quot;@(TransformsQualified)&quot;"
          Condition="%(Identity) == %(Identity) and '$(DeployBizTalkMgmtDB)' == 'false'" />

    <!-- Deploy PDBS to gac. -->
    <GeneratePdbCopyItemGroups SourceAssemblies="@(TransformsQualified)" Condition="'$(DeployPDBsToGac)' == 'true'">
      <Output TaskParameter="SourceItemGroup" ItemName="TransformsPdbSourceFilesGroup" />
      <Output TaskParameter="DestinationItemGroup" ItemName="TransformsPdbDestinationFilesGroup" />
    </GeneratePdbCopyItemGroups>
    <Copy SourceFiles="@(TransformsPdbSourceFilesGroup)" DestinationFiles="@(TransformsPdbDestinationFilesGroup)" Condition="'$(DeployPDBsToGac)' == 'true'"
          ContinueOnError="true" />
  </Target>

  <Target Name="UndeployTransforms" DependsOnTargets="UndeployOrchestrations" Condition="'$(IncludeTransforms)' == 'true' and '$(SkipUndeploy)' == 'false'">
    <!--
      Use the assembly's display name to remove the specific assembly from the GAC.
      If the version is not specified, gacutil removes all assemblies from the GAC that match on
      the filename, even if they have different strong names.
    -->
    <GenerateAssemblyNamesItemGroup SourceAssemblies="@(TransformsQualified)">
      <Output TaskParameter="AssemblyNamesItemGroup" ItemName="TransformAssemblyNamesGroup" />
    </GenerateAssemblyNamesItemGroup>

    <!-- When GACUTIL removes the assembly from the GAC, it will also remove the PDB file (copied when DeployPDBsToGac is enabled). -->
    <Exec Command="&quot;$(Gacutil)&quot; /u &quot;@(TransformAssemblyNamesGroup)&quot;" Condition="%(Identity) == %(Identity)" />
  </Target>

  <Target Name="DeployCustomFunctoids" Condition="'$(IncludeCustomFunctoids)' == 'true'">
    <Copy SourceFiles="@(CustomFunctoidsQualified)" DestinationFolder="$(BtsDir)Developer Tools\Mapper Extensions" ContinueOnError="true" />

    <Exec Command="&quot;$(Gacutil)&quot; /f /i &quot;@(CustomFunctoidsQualified)&quot;" Condition="%(Identity) == %(Identity)" />

    <!-- Deploy PDBS to gac. -->
    <GeneratePdbCopyItemGroups SourceAssemblies="@(CustomFunctoidsQualified)" Condition="'$(DeployPDBsToGac)' == 'true'">
      <Output TaskParameter="SourceItemGroup" ItemName="CustomFunctoidsPdbSourceFilesGroup" />
      <Output TaskParameter="DestinationItemGroup" ItemName="CustomFunctoidsPdbDestinationFilesGroup" />
    </GeneratePdbCopyItemGroups>
    <Copy SourceFiles="@(CustomFunctoidsPdbSourceFilesGroup)" DestinationFiles="@(CustomFunctoidsPdbDestinationFilesGroup)" Condition="'$(DeployPDBsToGac)' == 'true'"
          ContinueOnError="true" />
  </Target>

  <Target Name="UndeployCustomFunctoids" Condition="'$(IncludeCustomFunctoids)' == 'true' and '$(SkipUndeploy)' == 'false'">
    <!-- Delete pipeline component assemblies from BizTalk's Pipeline Components folder. -->
    <Delete Files="@(CustomFunctoids->'$(BtsDir)Developer Tools\Mapper Extensions\%(Identity)')" />

    <!-- Remove pipeline component assemblies from the GAC. -->
    <!--
      Use the assembly's display name to remove the specific assembly from the GAC.
      If the version is not specified, gacutil removes all assemblies from the GAC that match on
      the filename, even if they have different strong names.
    -->
    <GenerateAssemblyNamesItemGroup SourceAssemblies="@(CustomFunctoidsQualified)">
      <Output TaskParameter="AssemblyNamesItemGroup" ItemName="CustomFunctoidAssemblyNamesGroup" />
    </GenerateAssemblyNamesItemGroup>

    <!-- When GACUTIL removes the assembly from the GAC, it will also remove the PDB file (copied when DeployPDBsToGac is enabled). -->
    <Exec Command="&quot;$(Gacutil)&quot; /u &quot;@(CustomFunctoidAssemblyNamesGroup)&quot;" Condition="%(Identity) == %(Identity)" />
  </Target>

  <Target Name="_DeployVocabAndRules" DependsOnTargets="_UndeployVocabAndRules" Condition="'$(IncludeVocabAndRules)' == 'true'" >
    <!-- Publish vocabularies -->
    <Exec
      Command="&quot;$(DeployTools)\DeployBTRules.exe&quot; /ruleSetFile &quot;@(RuleVocabulariesQualified)&quot;"
      Condition="'@(RuleVocabulariesQualified)' != '' and '%(Identity)' == '%(Identity)' and Exists('%(FullPath)')" />

    <!-- Publish policies -->
    <Exec
      Command="&quot;$(DeployTools)\DeployBTRules.exe&quot; /ruleSetFile &quot;@(RulePoliciesQualified)&quot;"
      Condition="'@(RulePoliciesQualified)' != '' and '%(Identity)' == '%(Identity)' and Exists('%(FullPath)')" />

    <!--
    Create a new ItemGroup based on RulePoliciesQualified that includes additional metadata fields.
    The task will create a new item for every available ruleset in the policy files, even if there are multiple
    rulesets in a single file. Each item will have metadata items for policy name and version number.
    -->
    <PopulateRulePoliciesMetadata PolicyVocabFiles="@(RulePoliciesQualified)" Condition="'@(RulePoliciesQualified)' != '' and Exists('%(FullPath)')">
      <Output TaskParameter="PolicyVocabWithMetadata" ItemName="RulePoliciesQualifiedPlusDeploy" />
    </PopulateRulePoliciesMetadata>

    <!-- Associate the policies with the BizTalk application. BizTalk will deploy the policies when the BizTalk app starts. -->
    <Exec
      Command="BTSTask.exe AddResource -Type:System.BizTalk:Rules -Overwrite -Name:&quot;@(RulePoliciesQualifiedPlusDeploy->'%(PolicyName)')&quot; -Version:&quot;%(PolicyVersion)&quot; -ApplicationName:&quot;$(BizTalkAppName)&quot;"
      Condition="'@(RulePoliciesQualifiedPlusDeploy)' != '' and '%(Identity)' == '%(Identity)'" />

    <!-- Deploy the published policies - we normally skip this because BizTalk will do it when the app starts -->
    <Exec
      Command="&quot;$(DeployTools)\DeployBTRules.exe&quot; /ruleSetName &quot;@(RulePoliciesQualifiedPlusDeploy->'%(PolicyName)')&quot; /ruleSetVersion &quot;@(RulePoliciesQualifiedPlusDeploy->'%(PolicyVersion)')&quot;"
      Condition="'$(ExplicitlyDeployRulePoliciesOnDeploy)' == 'true' and '@(RulePoliciesQualifiedPlusDeploy)' != '' and '%(Identity)' == '%(Identity)'" />

    <Pause Message="Press a key to continue..." Condition="'$(Interactive)' == 'true'" />

    <OnError ExecuteTargets="PauseForError" />
  </Target>
  
  <Target Name="DeployVocabAndRules" Condition="'$(IncludeVocabAndRules)' == 'true'" DependsOnTargets="SetDeployVocabAndRulesProperties;LoadPropsFromEnvSettingsThenExecute" />

  <Target Name="SetDeployVocabAndRulesProperties">
    <PropertyGroup>
      <TargetsAfterLoadPropsFromEnvSettings>_DeployVocabAndRules</TargetsAfterLoadPropsFromEnvSettings>
    </PropertyGroup>
  </Target>

  <Target Name="_UndeployVocabAndRules" Condition="'$(IncludeVocabAndRules)' == 'true' and '$(SkipUndeploy)' == 'false'">
    <!--
    Create a new ItemGroup based on RulePoliciesQualified that includes additional metadata fields.
    The task will create a new item for every available ruleset in the policy files, even if there are multiple
    rulesets in a single file. Each item will have metadata items for policy name and version number.
    -->
    <PopulateRulePoliciesMetadata PolicyVocabFiles="@(RulePoliciesQualified)" Reverse="true" Condition="'@(RulePoliciesQualified)' != '' and Exists('%(FullPath)')">
      <Output TaskParameter="PolicyVocabWithMetadata" ItemName="RulePoliciesQualifiedPlusUndeploy" />
    </PopulateRulePoliciesMetadata>
    <PopulateRulePoliciesMetadata PolicyVocabFiles="@(RuleVocabulariesQualified)" Reverse="true" Condition="'@(RuleVocabulariesQualified)' != '' and Exists('%(FullPath)')">
      <Output TaskParameter="PolicyVocabWithMetadata" ItemName="RuleVocabulariesQualifiedPlus" />
    </PopulateRulePoliciesMetadata>

    <!-- Disassociate the policies from the BizTalk application. Normally we skip this because we will typically delete
        the entire BizTalk application later in the undeployment. -->
    <Exec
      Command="BTSTask.exe RemoveResource -Luid:&quot;@(RulePoliciesQualifiedPlusUndeploy->'%(Luid)')&quot; -ApplicationName:&quot;$(BizTalkAppName)&quot;"
      Condition="'$(RemoveRulePoliciesFromAppOnUndeploy)' == 'true' and '@(RulePoliciesQualifiedPlusUndeploy)' != '' and '%(Identity)' == '%(Identity)'"
      ContinueOnError="true" />

    <!-- Undeploy and unpublish the policies. -->
    <Exec
      Command="&quot;$(DeployTools)\DeployBTRules.exe&quot; /ruleSetName &quot;@(RulePoliciesQualifiedPlusUndeploy->'%(PolicyName)')&quot; /ruleSetVersion &quot;%(PolicyVersion)&quot; /unpublish /undeploy"
      Condition="'@(RulePoliciesQualifiedPlusUndeploy)' != '' and '%(Identity)' == '%(Identity)'" />

    <!-- Undeploy and unpublish the vocabularies. -->
    <Exec
      Command="&quot;$(DeployTools)\DeployBTRules.exe&quot; /vocabularyName &quot;@(RuleVocabulariesQualifiedPlus->'%(PolicyName)')&quot; /ruleSetVersion &quot;%(PolicyVersion)&quot; /unpublish /undeploy"
      Condition="'%(Identity)' == '%(Identity)' and '@(RuleVocabulariesQualifiedPlus)' != ''" />
  </Target>
  
  <Target Name="UndeployVocabAndRules" Condition="'$(IncludeVocabAndRules)' == 'true'" DependsOnTargets="SetUndeployVocabAndRulesProperties;LoadPropsFromEnvSettingsThenExecute" />

  <Target Name="SetUndeployVocabAndRulesProperties">
    <PropertyGroup>
      <TargetsAfterLoadPropsFromEnvSettings>_UndeployVocabAndRules</TargetsAfterLoadPropsFromEnvSettings>
    </PropertyGroup>
  </Target>

  <PropertyGroup>
    <_DeploySSODependsOn>
      ExportSettings;
      CustomPostExportSettings;
      InitSettingsFilePath
    </_DeploySSODependsOn>
  </PropertyGroup>

  <Target Name="_DeploySSO" DependsOnTargets="$(_DeploySSODependsOn)" Condition="'$(IncludeSSO)' == 'true'">
    <!-- Create affiliate app and import settings file into SSO. -->

    <Exec
      Command="&quot;$(DeployTools)\SSOSettingsFileImport.exe&quot; &quot;$(BizTalkAppName)&quot; /settingsFile:&quot;$(SettingsFilePath)&quot; /userGroupName:&quot;$(SsoAppUserGroup)&quot; /adminGroupName:&quot;$(SsoAppAdminGroup)&quot;"
      Condition="'$(SettingsFilePath)' != ''"/>

    <CallTarget Targets="CustomSSO" />

    <!-- Make sure we can always access our project (and install path) at run time -->
    <UpdateSSOConfigItem BizTalkAppName="$(BizTalkAppName)" SSOItemName="ProjectPath" SSOItemValue="$(MSBuildProjectDirectoryParent)" />
    <UpdateSSOConfigItem BizTalkAppName="$(BizTalkAppName)" SSOItemName="SourceSettingsFile" SSOItemValue="$(SettingsFilePath)" />

    <Pause Message="Press a key to continue..." Condition="'$(Interactive)' == 'true'" />

    <OnError ExecuteTargets="PauseForError" />
  </Target>
  
  <Target Name="DeploySSO" Condition="'$(IncludeSSO)' == 'true'" DependsOnTargets="SetDeploySSOProperties;LoadPropsFromEnvSettingsThenExecute" />

  <Target Name="SetDeploySSOProperties">
    <PropertyGroup>
      <TargetsAfterLoadPropsFromEnvSettings>_DeploySSO</TargetsAfterLoadPropsFromEnvSettings>
    </PropertyGroup>
  </Target>

  <Target Name="UndeploySSO" Condition="'$(IncludeSSO)' == 'true' and '$(SkipUndeploy)' == 'false'">
    <!-- Delete affiliate app and associated settings. -->

    <Exec Command="&quot;$(DeployTools)\SSOSettingsFileImport.exe&quot; &quot;$(BizTalkAppName)&quot; /deleteApp" />
  </Target>

  <ItemDefinitionGroup>
    <IISAppPool>
      <DotNetFrameworkVersion>v4.0</DotNetFrameworkVersion>
      <PipelineMode>Integrated</PipelineMode>
      <Enable32Bit>False</Enable32Bit>
      <IdentityType>ApplicationPoolIdentity</IdentityType>
      <DeployAction>$(IISAppPoolDefaultDeployAction)</DeployAction>
      <UndeployAction>$(IISAppPoolDefaultUndeployAction)</UndeployAction>
    </IISAppPool>
  </ItemDefinitionGroup>

  <ItemDefinitionGroup>
    <IISApp>
      <SiteName>Default Web Site</SiteName>
      <DeployAction>CreateOrUpdate</DeployAction>
      <UndeployAction>Delete</UndeployAction>
    </IISApp>
  </ItemDefinitionGroup>
  
  <PropertyGroup>
    <DeployVDirsDependsOn>
      VDirListItemGroupGuard;
      DeployIISAppPools;
      DeployIISApplications;
      DeployIISExtensions;
      DeployNTFSPermissionsOnVDirPaths;
    </DeployVDirsDependsOn>
  </PropertyGroup>
  
  <Target Name="DeployVDirs" DependsOnTargets="$(DeployVDirsDependsOn)" Condition="'$(IncludeVirtualDirectories)' == 'true'" />

  <PropertyGroup>
    <UndeployVDirsDependsOn>
      UndeployIISExtensions;
      UndeployIISApplications;
      UndeployIISAppPools
    </UndeployVDirsDependsOn>
  </PropertyGroup>

  <Target Name="UndeployVDirs" DependsOnTargets="$(UndeployVDirsDependsOn)" Condition="'$(IncludeVirtualDirectories)' == 'true' and '$(SkipUndeploy)' == 'false'" />

  <Target Name="VDirListItemGroupGuard" Condition="'@(VDirList)' != ''">
    <Error Text="The VDirList ItemGroup is no longer supported.  Please convert to IISAppPool and IISApp." />
  </Target>

  <Target Name="DeployNTFSPermissionsOnVDirPaths" Condition="'$(ModifyNTFSPermissionsOnVDirPaths)' == 'true'">
    <ConfigureVirtualDirectoryNtfsPermissions Items="@(IISApp)" MSBuildProjectDirectory="$(MSBuildProjectDirectory)" Mode="Deploy" />
  </Target>
  
  <Target Name="DeployIISAppPools" Condition="'@(IISAppPool)' != ''">
    <ConfigureAppPool Items="@(IISAppPool)"  MSBuildProjectDirectory="$(MSBuildProjectDirectory)" Mode="Deploy" />
  </Target>

  <Target Name="UndeployIISAppPools" Condition="'@(IISAppPool)' != ''">
    <ConfigureAppPool Items="@(IISAppPool)"  MSBuildProjectDirectory="$(MSBuildProjectDirectory)" Mode="Undeploy" />
  </Target>

  <Target Name="DeployIISApplications" Condition="'@(IISApp)' != ''">
    <ConfigureVirtualDirectory Items="@(IISApp)" MSBuildProjectDirectory="$(MSBuildProjectDirectory)" Mode="Deploy" />
  </Target>

  <Target Name="UndeployIISApplications" Condition="'@(IISApp)' != ''">
    <ConfigureVirtualDirectory Items="@(IISApp)" MSBuildProjectDirectory="$(MSBuildProjectDirectory)" Mode="Undeploy" />
  </Target>

  <Target Name="DeployIISExtensions" Condition="'@(IISApp)' != ''">
    <ConfigureWebServiceExtension Items="@(IISApp)" MSBuildProjectDirectory="$(MSBuildProjectDirectory)" Mode="Deploy" />
  </Target>

  <Target Name="UndeployIISExtensions" Condition="'@(IISApp)' != ''">
    <ConfigureWebServiceExtension Items="@(IISApp)" MSBuildProjectDirectory="$(MSBuildProjectDirectory)" Mode="Undeploy" />
  </Target>

  <!-- This target imports the binding file into BizTalk -->
  <Target Name="_ImportBindings" Condition="'$(IncludeMessagingBindings)' == 'true'" >
    <ItemGroupFromSeparatedList SeparatedList="$(PortBindings)" FormatString="$(MSBuildProjectDirectory)\{0}" ReverseList="false">
      <Output TaskParameter="ItemGroup" ItemName="DeployPortBindingsGroup" />
    </ItemGroupFromSeparatedList>

    <!-- Binding file name must be unique for the whole BizTalk group, so prepend the app name (incl. version number if SxS) -->
    <ItemGroupFromSeparatedList SeparatedList="$(PortBindings)" FormatString="$(MSBuildProjectDirectory)\$(BizTalkAppName)_{0}" ReverseList="false">
      <Output TaskParameter="ItemGroup" ItemName="DeployQualifiedPortBindingsGroup" />
    </ItemGroupFromSeparatedList>

    <Copy SourceFiles="@(DeployPortBindingsGroup)" DestinationFiles="@(DeployQualifiedPortBindingsGroup)" />

    <Exec
      Command="BTSTask.exe AddResource -Type:BizTalkBinding -Overwrite -Source:&quot;@(DeployQualifiedPortBindingsGroup)&quot; -ApplicationName:&quot;$(BizTalkAppName)&quot;"
      Condition="%(Identity) == %(Identity)" />

    <Delete Files="@(DeployQualifiedPortBindingsGroup)" />

    <Exec
        Command="BTSTask.exe ImportBindings -Source:&quot;@(DeployPortBindingsGroup)&quot; -ApplicationName:&quot;$(BizTalkAppName)&quot;"
        Condition="%(Identity) == %(Identity)"/>

    <Pause Message="Press a key to continue..." Condition="'$(Interactive)' == 'true'" />

    <OnError ExecuteTargets="PauseForError" />
  </Target>
  
  <Target Name="ImportBindings" DependsOnTargets="SetImportBindingsProperties;LoadPropsFromEnvSettingsThenExecute" />

  <Target Name="SetImportBindingsProperties">
    <PropertyGroup>
      <TargetsAfterLoadPropsFromEnvSettings>_ImportBindings</TargetsAfterLoadPropsFromEnvSettings>
    </PropertyGroup>
  </Target>

  <Target Name="_PreprocessAndImportBindings" DependsOnTargets="_PreprocessBindings;_ImportBindings" Condition="'$(IncludeMessagingBindings)' == 'true'" />

  <Target Name="PreprocessAndImportBindings" Condition="'$(IncludeMessagingBindings)' == 'true'" DependsOnTargets="SetPreprocessAndImportBindingsProperties;LoadPropsFromEnvSettingsThenExecute" />
  
  <Target Name="SetPreprocessAndImportBindingsProperties">
    <PropertyGroup>
      <TargetsAfterLoadPropsFromEnvSettings>_PreprocessAndImportBindings</TargetsAfterLoadPropsFromEnvSettings>
    </PropertyGroup>
  </Target>

  <!-- Indicates the flags from the ApplicationStartOption enumeration used when starting a BizTalk application -->
  <PropertyGroup Condition="'$(ControlBizTalkAppStartOption)' == ''">
    <ControlBizTalkAppStartOption
      Condition="'$(EnableAllReceiveLocationsOnDeploy)' == 'true' and '$(StartReferencedApplicationsOnDeploy)' == 'true'">StartAll</ControlBizTalkAppStartOption>
    <ControlBizTalkAppStartOption
      Condition="'$(EnableAllReceiveLocationsOnDeploy)' == 'false' and '$(StartReferencedApplicationsOnDeploy)' == 'true'">StartAllOrchestrations,StartAllSendPortGroups,StartAllSendPorts,DeployAllPolicies,StartReferencedApplications</ControlBizTalkAppStartOption>
    <ControlBizTalkAppStartOption
      Condition="'$(EnableAllReceiveLocationsOnDeploy)' == 'true' and '$(StartReferencedApplicationsOnDeploy)' == 'false'">StartAllOrchestrations,StartAllSendPortGroups,StartAllSendPorts,DeployAllPolicies,EnableAllReceiveLocations</ControlBizTalkAppStartOption>
    <ControlBizTalkAppStartOption
      Condition="'$(EnableAllReceiveLocationsOnDeploy)' == 'false' and '$(StartReferencedApplicationsOnDeploy)' == 'false'">StartAllOrchestrations,StartAllSendPortGroups,StartAllSendPorts,DeployAllPolicies</ControlBizTalkAppStartOption>
  </PropertyGroup>
  
  <Target Name="StartApplication" Condition="'$(StartApplicationOnDeploy)' == 'true'" DependsOnTargets="StartApplicationViaBizTalk;StartTheApplication" />

  <Target Name="StartApplicationViaBizTalk" Condition="'$(UseLegacyApplicationControl)' == 'true'">
    <PropertyGroup>
      <StartApplicationTime>$([System.DateTime]::Now.ToString('MM-dd-yy hh:mm:ss'))</StartApplicationTime>
    </PropertyGroup>
    <Message Text="Starting $(BizTalkAppName) application at $(StartApplicationTime)."/>

    <ControlBizTalkApp ApplicationName="$(BizTalkAppName)" StartOption="$(ControlBizTalkAppStartOption)" />
  </Target>

  <Target Name="StartTheApplication" Condition="'$(UseLegacyApplicationControl)' != 'true'">
    <PropertyGroup>
      <StartApplicationTime>$([System.DateTime]::Now.ToString('MM-dd-yy hh:mm:ss'))</StartApplicationTime>
      <StartReceiveLocationsDefaultAction Condition="'$(StartReceiveLocationsDefaultAction)' == '' and '$(EnableAllReceiveLocationsOnDeploy)' == 'true'">Enable</StartReceiveLocationsDefaultAction>
      <StartReceiveLocationsDefaultAction Condition="'$(StartReceiveLocationsDefaultAction)' == '' and '$(EnableAllReceiveLocationsOnDeploy)' != 'true'">Disable</StartReceiveLocationsDefaultAction>
      <StartSendPortsDefaultAction Condition="'$(StartSendPortsDefaultAction)' == ''">Start</StartSendPortsDefaultAction>
      <StartSendPortGroupsDefaultAction Condition="'$(StartSendPortGroupsDefaultAction)' == ''">Start</StartSendPortGroupsDefaultAction>
      <StartOrchestrationsDefaultAction Condition="'$(StartOrchestrationsDefaultAction)' == ''">Start</StartOrchestrationsDefaultAction>
      <StartReferencedAppsDefaultAction Condition="'$(StartReferencedAppsDefaultAction)' == ''">Start</StartReferencedAppsDefaultAction>
    </PropertyGroup>
    
    <Message Text="Starting $(BizTalkAppName) application at $(StartApplicationTime)."/>

    <ControlBizTalkReferencedApps Mode="Deploy" DefaultAction="$(StartReferencedAppsDefaultAction)" ApplicationName="$(BizTalkAppName)" Artifacts="@(AppsToReference)" />
    <ControlBizTalkSendPorts Mode="Deploy" DefaultAction="$(StartSendPortsDefaultAction)" ApplicationName="$(BizTalkAppName)" Artifacts="@(SendPortAction)" />
    <ControlBizTalkSendPortGroups Mode="Deploy" DefaultAction="$(StartSendPortGroupsDefaultAction)" ApplicationName="$(BizTalkAppName)" Artifacts="@(SendPortGroupAction)" />
    <ControlBizTalkOrchestrations Mode="Deploy" DefaultAction="$(StartOrchestrationsDefaultAction)" ApplicationName="$(BizTalkAppName)" Artifacts="@(OrchestrationAction)" />
    <ResumeServiceInstances Application="$(BizTalkAppName)" Condition="'$(ResumeSuspendedInstancesOnDeploy)' == 'true'" />
    <ControlBizTalkReceiveLocations Mode="Deploy" DefaultAction="$(StartReceiveLocationsDefaultAction)" ApplicationName="$(BizTalkAppName)" Artifacts="@(ReceiveLocationAction)" />
  </Target>

  <!-- Indicates the flags from the ApplicationStopOption enumeration used when starting a BizTalk application -->
  <PropertyGroup Condition="'$(ControlBizTalkAppStopOption)' == ''">
    <ControlBizTalkAppStopOption>DisableAllReceiveLocations,UndeployAllPolicies,UnenlistAllOrchestrations,UnenlistAllSendPortGroups,UnenlistAllSendPorts</ControlBizTalkAppStopOption>
  </PropertyGroup>

  <Target Name="StopApplication" Condition="'$(StopApplicationOnDeploy)' == 'true'" DependsOnTargets="VerifyBizTalkAppExists;StopApplicationViaBizTalk;StopTheApplication" />

  <Target Name="StopApplicationViaBizTalk" Condition="'$(UseLegacyApplicationControl)' == 'true' and '$(AppExists)' == 'true'">
    <ControlBizTalkApp
      ApplicationName="$(BizTalkAppName)" StopOption="$(ControlBizTalkAppStopOption)"
      ContinueOnError="true"/>
  </Target>

  <Target Name="StopTheApplication" Condition="'$(UseLegacyApplicationControl)' != 'true' and '$(AppExists)' == 'true'">
    <PropertyGroup>
      <StopApplicationTime>$([System.DateTime]::Now.ToString('MM-dd-yy hh:mm:ss'))</StopApplicationTime>
      <StopReceiveLocationsDefaultAction Condition="'$(StopReceiveLocationsDefaultAction)' == ''">Disable</StopReceiveLocationsDefaultAction>
      <StopSendPortsDefaultAction Condition="'$(StopSendPortsDefaultAction)' == ''">Unenlist</StopSendPortsDefaultAction>
      <StopSendPortGroupsDefaultAction Condition="'$(StopSendPortGroupsDefaultAction)' == ''">Unenlist</StopSendPortGroupsDefaultAction>
      <StopOrchestrationsDefaultAction Condition="'$(StopOrchestrationsDefaultAction)' == ''">Unenlist</StopOrchestrationsDefaultAction>
    </PropertyGroup>
    
    <Message Text="Stopping $(BizTalkAppName) application at $(StopApplicationTime)."/>

    <ControlBizTalkReceiveLocations Mode="Undeploy" DefaultAction="$(StopReceiveLocationsDefaultAction)" ApplicationName="$(BizTalkAppName)" Artifacts="@(ReceiveLocationAction)" />
    <ControlBizTalkOrchestrations Mode="Undeploy" DefaultAction="$(StopOrchestrationsDefaultAction)" ApplicationName="$(BizTalkAppName)" Artifacts="@(OrchestrationAction)" />
    <ControlBizTalkSendPortGroups Mode="Undeploy" DefaultAction="$(StopSendPortGroupsDefaultAction)" ApplicationName="$(BizTalkAppName)" Artifacts="@(SendPortGroupAction)" />
    <ControlBizTalkSendPorts Mode="Undeploy" DefaultAction="$(StopSendPortsDefaultAction)" ApplicationName="$(BizTalkAppName)" Artifacts="@(SendPortAction)" />
  </Target>

  <Target Name="VerifyBizTalkAppExists">
    <GetBizTalkAppExists ApplicationName="$(BizTalkAppName)">
      <Output TaskParameter="AppExists" PropertyName="AppExists" />
    </GetBizTalkAppExists>
  </Target>

  <Target Name="DeployBam" DependsOnTargets="ExportBAMXMLFromXLS;UndeployBam" Condition="'$(IncludeBAM)' == 'true'">
    <!-- First, deploy the BAM definitions -->
    <Message Text="Deploying BAM definition..." />
    <Exec
       Command="&quot;$(BtsDir)Tracking\bm.exe&quot; update-all -DefinitionFile:&quot;@(BamDefinitionsQualified->'%(RootDir)%(Directory)%(Filename).xml')&quot;"
       Condition="'%(Identity)' == '%(Identity)'" />
    <!--
      Make a copy of the BAM definition XML as [filename]_LastAutoDeploy.xml. Next time we undeploy, we'll look
      for that file first in case the definition file no longer matches what is deployed. If there is a mismatch,
      bm.exe won't auto-undeploy the model.
    -->
    <MakeFilesWriteable
      InputFiles="@(BamDefinitionsQualified->'%(RootDir)%(Directory)%(Filename)_LastAutoDeploy.xml')"
      Condition="Exists(@(BamDefinitionsQualified->'%(RootDir)%(Directory)%(Filename)_LastAutoDeploy.xml')) and '%(Identity)' == '%(Identity)'" />
    <Copy
      SourceFiles="@(BamDefinitionsQualified->'%(RootDir)%(Directory)%(Filename).xml')"
      DestinationFiles="@(BamDefinitionsQualified->'%(RootDir)%(Directory)%(Filename)_LastAutoDeploy.xml')" />
    <Message Text="Finished deploying BAM definition." />

    <Message Text="Deploying BAM security..." />
    <!-- Next, apply permissions to the BAM views -->
    <!-- View names and associated accounts must be defined in a property called BAMViewsAndAccounts -->
    <!-- The format of the value of the BAMViewsAndAccounts property must be: -->
    <!-- ViewName1:DOMAIN\GroupName1,DOMAIN\UserName1;ViewName2:BUILTIN\Administrators,COMPUTERNAME\UserName2;<etc. etc.> -->
    <!-- This is easily pulled from the settings spreadsheet by including BAMViewsAndAccounts in the PropsFromEnvSettings ItemGroup. -->
    <ItemGroupFromSeparatedList SeparatedList="$(BAMViewsAndAccounts)" FormatString="{0}" Separator=";" ReverseList="false" ListItemRegex="$(BAMViewSecurityRegEx)"
                                Condition="'$(BAMViewsAndAccounts)' != ''">
      <Output TaskParameter="ItemGroup" ItemName="BAMViewsAndAccountsGroup" />
    </ItemGroupFromSeparatedList>

    <Exec
     Command="&quot;$(BtsDir)Tracking\bm.exe&quot; add-account -View:&quot;%(BAMViewsAndAccountsGroup.viewName)&quot; -AccountName:&quot;%(BAMViewsAndAccountsGroup.groupNames)&quot;"
     ContinueOnError="true"
     Condition="'%(Identity)' == '%(Identity)' and '$(BAMViewsAndAccounts)' != ''"/>
    <Message Text="Finished deploying BAM security." />

    <Message Text="Deploying BAM tracking profiles..." Condition="'@(BamTrackingProfilesQualified)' != ''" />
    <Exec
      Command="&quot;$(BtsDir)Tracking\BttDeploy.exe&quot; &quot;@(BamTrackingProfilesQualified)&quot;"
      Condition="'%(Identity)' == '%(Identity)' and '@(BamTrackingProfilesQualified)' != ''" />
    <Message Text="Finished deploying BAM tracking profiles." Condition="'@(BamTrackingProfilesQualified)' != ''" />
  </Target>

  <Target Name="UndeployBam" DependsOnTargets="ExportBAMXMLFromXLS" Condition="'$(IncludeBAM)' == 'true' and ('$(SkipUndeploy)' == 'false' and '$(SkipBamUndeploy)' == 'false')">
    <Message Text="Undeploying BAM tracking profiles..." Condition="'@(BamTrackingProfilesQualified)' != ''" />
    <Exec
      Command="&quot;$(BtsDir)Tracking\BttDeploy.exe&quot; /remove &quot;@(BamTrackingProfilesQualified)&quot;"
      Condition="'%(Identity)' == '%(Identity)' and '@(BamTrackingProfilesQualified)' != ''"
      ContinueOnError="true" />
    <Message Text="Finished undeploying BAM tracking profiles." Condition="'@(BamTrackingProfilesQualified)' != ''" />

    <Message Text="Undeploying BAM definition..." />
    <Exec
       Command="&quot;$(BtsDir)Tracking\bm.exe&quot; remove-all -DefinitionFile:&quot;@(BamDefinitionsQualified->'%(RootDir)%(Directory)%(Filename)_LastAutoDeploy.xml')&quot;"
       Condition="Exists('%(RootDir)%(Directory)%(Filename)_LastAutoDeploy.xml') and '%(Identity)' == '%(Identity)'" />
    <Exec
       Command="&quot;$(BtsDir)Tracking\bm.exe&quot; remove-all -DefinitionFile:&quot;@(BamDefinitionsQualified->'%(RootDir)%(Directory)%(Filename).xml')&quot;"
       Condition="!Exists('%(RootDir)%(Directory)%(Filename)_LastAutoDeploy.xml') and '%(Identity)' == '%(Identity)'" />
    <Message Text="Finished undeploying BAM definition." />
  </Target>

  <Target Name="ExportBAMXMLFromXLS" Condition="'$(IncludeBAM)' == 'true' and '$(Configuration)' != 'Server'">
    <Exec Command="&quot;$(DeployTools)\ExportBamDefinitionXml.exe&quot; &quot;%(BamDefinitionsQualified.FullPath)&quot; &quot;@(BamDefinitionsQualified->'%(RootDir)%(Directory)%(Filename).xml')&quot;" />
  </Target>

  <Target Name="DeployEsbItineraries" DependsOnTargets="UndeployEsbItineraries" Condition="'$(IncludeEsbItineraries)' == 'true'">
    <Exec
      Command="&quot;$(EsbImportUtil)&quot; /f:&quot;@(EsbItinerariesQualified)&quot; /o /c:deployed" Condition="'%(Identity)' == '%(Identity)'" />
  </Target>

  <Target Name="UndeployEsbItineraries" Condition="'$(IncludeEsbItineraries)' == 'true' and '$(SkipUndeploy)' == 'false'">
  </Target>

  <Target Name="TerminateServiceInstancesConditional" Condition="'$(AutoTerminateInstances)' == 'true'">
    <TerminateServiceInstances Application="$(BizTalkAppName)" />
  </Target>

  <Target Name="_TerminateServiceInstances">
    <TerminateServiceInstances Application="$(BizTalkAppName)" />

    <Pause Message="Press a key to continue..." Condition="'$(Interactive)' == 'true'" />

    <OnError ExecuteTargets="PauseForError" />
  </Target>
  
  <Target Name="TerminateServiceInstances" DependsOnTargets="SetTerminateServiceInstancesProperties;LoadPropsFromEnvSettingsThenExecute" />

  <Target Name="SetTerminateServiceInstancesProperties">
    <PropertyGroup>
      <TargetsAfterLoadPropsFromEnvSettings>_TerminateServiceInstances</TargetsAfterLoadPropsFromEnvSettings>
    </PropertyGroup>
  </Target>
  
  <Target Name="DecodeBindings">
    <Exec
       Command="&quot;$(DeployTools)\ElementTunnel.exe&quot; /i:&quot;$(MSBuildProjectDirectory)\$(SourceBindingFile)&quot; /o:&quot;$(MSBuildProjectDirectory)\$(SourceBindingFile)&quot; /x:&quot;$(XmlEscapeXPathsFile)&quot; /decode" />
  </Target>

  <Target Name="SetToolsVersionParam">
    <PropertyGroup>
      <ToolsVersionParam Condition="'$(MSBuildToolsVersion)' == '4.0'">/tv:4.0</ToolsVersionParam>
    </PropertyGroup>
  </Target>

  <Target Name="LaunchServerDeployWizard" DependsOnTargets="SetToolsVersionParam;ExportSettings" Condition="'$(Configuration)' == 'Server'">
    <Exec
       Command="&quot;$(DeployTools)\SetEnvUI.exe&quot; /c:InstallWizard.xml /p:&quot;$(MSBuildBinPath)\MSBuild.exe&quot; /a:&quot;Framework\BizTalkDeploymentFramework.ServerExecute.targets /t:Deploy /clp:NoSummary;DisableMPLogging /nologo /p:Interactive=True /p:ProjectFile=$(MSBuildProjectFile) $(ToolsVersionParam)&quot;" />
  </Target>

  <Target Name="LaunchServerRedeployWizard" DependsOnTargets="SetToolsVersionParam;ExportSettings" Condition="'$(Configuration)' == 'Server'">
    <Exec
       Command="&quot;$(DeployTools)\SetEnvUI.exe&quot; /c:InstallWizard.xml /p:&quot;$(MSBuildBinPath)\MSBuild.exe&quot; /a:&quot;Framework\BizTalkDeploymentFramework.ServerExecute.targets /t:Redeploy /clp:NoSummary;DisableMPLogging /nologo /p:Interactive=True /p:ProjectFile=$(MSBuildProjectFile) $(ToolsVersionParam)&quot;" />
  </Target>

  <Target Name="LaunchServerUndeployWizard" DependsOnTargets="SetToolsVersionParam;ExportSettings" Condition="'$(Configuration)' == 'Server'">
    <Exec
       Command="&quot;$(DeployTools)\SetEnvUI.exe&quot; /c:UnInstallWizard.xml /p:&quot;$(MSBuildBinPath)\MSBuild.exe&quot; /a:&quot;Framework\BizTalkDeploymentFramework.ServerExecute.targets /t:Undeploy /clp:NoSummary;DisableMPLogging /nologo /p:Interactive=True /p:ProjectFile=$(MSBuildProjectFile) $(ToolsVersionParam)&quot;" />
  </Target>

  <Target Name="LaunchServerQuickDeploy" DependsOnTargets="SetToolsVersionParam" Condition="'$(Configuration)' == 'Server'">
    <StartProcess
       Command="&quot;$(MSBuildBinPath)\MSBuild.exe&quot;"
       Arguments="Framework\BizTalkDeploymentFramework.ServerExecute.targets /t:QuickDeploy /clp:NoSummary;DisableMPLogging /nologo /p:Interactive=True /p:ProjectFile=$(MSBuildProjectFile) $(ToolsVersionParam)" />
  </Target>

  <Target Name="PauseForError" Condition="'$(Interactive)' == 'true'">
    <Message Text="*************************************" />
    <Message Text="************* FAILED! ***************" />
    <Message Text="*************************************" />
    <Pause Message="Press a key to continue..." />
  </Target>

  <Import Project="BizTalkDeploymentFramework.WiXSetup.targets"/>
</Project>
